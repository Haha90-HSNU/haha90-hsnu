"use strict";var theWorldSun,theWorldEarth1,theWorldEarth2,theWorldMan,theSkyBall,theStarBall,theWorldMap,sunLongitude,sunLatitude,dateNow,fps=30,log=console.log,cos=Math.cos,sin=Math.sin,PI=Math.PI,nnDaysPerYear=360,obliquity=23.5*PI/180,eccentricity=0,pTheta0=0,timeNow=0,timeView=0,thetaB=0,thetaS=0,manLongitude=0*Math.PI/180,manLatitude=0*Math.PI/180,zoomMD=0,zoomMDOld=0,zoomTaregt=0,isZooming=!1,mapRatio=0,mapRatioOld=.5,mappingTarget=0,isMapping=!1,needToSetTime=!1,isPlay=!0,isStep=!1,isPlaying24=!1,timeTarget=0,dtMD="H",countFPS=30,dateOld=new Date;function init(){initControls(),setToPlanet(1),makeWorlds(),world2D.btnZoom0.on("click",clickBtnZoom),world2D.btnZoom1.on("click",clickBtnZoom),world2D.btnZoom2.on("click",clickBtnZoom),world2D.btnZoom3.on("click",clickBtnZoom),world2D.btnZoomM.on("click",clickBtnZoom),setInterval(tick,1e3/fps)}function tick(){let t=(dateNow=new Date).getTime()-dateOld.getTime();countFPS=.98*countFPS+1e3/t*.02,world2D.textFPS.text="fps="+Math.round(10*countFPS)/10,obliquity=world2D.controlPlanet.nsObliquity.value*Math.PI/180,nnDaysPerYear=world2D.controlPlanet.nsNNDaysPerYear.value,world2D.controlTimer.nsDD.maximum=nnDaysPerYear-1,eccentricity=world2D.controlPlanet.nsEccentricity.value,pTheta0=world2D.controlPlanet.nsPTheta0.value*Math.PI/180,manLongitude=world2D.controlMan.nsManLo.value*Math.PI/180,(manLatitude=world2D.controlMan.nsManLa.value*Math.PI/180)>0?world2D.controlMan.nsManLa.valueText.text="N"+Math.round(Math.abs(180*manLatitude/PI)):manLatitude<0&&(world2D.controlMan.nsManLa.valueText.text="S"+Math.round(Math.abs(180*manLatitude/PI))),manLongitude>0?world2D.controlMan.nsManLo.valueText.text="W"+Math.round(Math.abs(180*manLongitude/PI)):manLongitude<0&&(world2D.controlMan.nsManLo.valueText.text="E"+Math.round(Math.abs(180*manLongitude/PI)));var e=1;if("S"===dtMD?e=1:"M"===dtMD?e=60:"H"===dtMD?e=3600:"D"===dtMD&&(e=86400),world2D.controlTimer.dtBtnBG.x=world2D.controlTimer["dtBtn"+dtMD+dtMD].x,isPlaying24&&(zoomMD>=2||zoomMD<=1.5))if(timeNow<timeTarget)for(timeNow+=600,timeNow%=24*nnDaysPerYear*60*60;timeTarget>timeNow+86400;)timeTarget-=86400;else timeNow=timeTarget,isPlaying24=!1,world2D.controlSkyBall.chAuto.checked&&addARecord();else(zoomMD>=2||zoomMD<=1.5)&&isPlay&&(timeNow+=e,timeNow%=24*nnDaysPerYear*60*60,world2D.controlSkyBall.chAuto.checked&&addARecord());if(needToSetTime&&!isPlaying24){var o=world2D.controlTimer.nsSS.value,n=world2D.controlTimer.nsMM.value,a=world2D.controlTimer.nsHH.value,r=world2D.controlTimer.nsDD.value;timeNow=o+60*n+60*a*60+60*r*60*24+manLongitude/(2*Math.PI)*24*60*60,needToSetTime=!1,0!==world2D.controlTimer.nsSS.ccount&&(needToSetTime=!0),0!==world2D.controlTimer.nsMM.ccount&&(needToSetTime=!0),0!==world2D.controlTimer.nsHH.ccount&&(needToSetTime=!0),0!==world2D.controlTimer.nsDD.ccount&&(needToSetTime=!0)}else{var i=timeNow-manLongitude/(2*Math.PI)*24*60*60;i<0&&(i+=24*nnDaysPerYear*60*60),i>24*nnDaysPerYear*60*60&&(i+=24*nnDaysPerYear*60*60),world2D.controlTimer.nsSS.value=i%60,world2D.controlTimer.nsMM.value=Math.floor(i%3600/60),world2D.controlTimer.nsHH.value=Math.floor(i%86400/3600),world2D.controlTimer.nsDD.value=Math.floor(i/86400)}(isStep=world2D.controlTimer.chStep.checked)&&(isPlay=!1);var l=calSunPosition(timeNow);if(thetaB=l[0],thetaS=l[1],sunLongitude=l[2],sunLatitude=l[3],world2D.btnZoom0.alpha=world2D.btnZoom1.alpha=world2D.btnZoom2.alpha=world2D.btnZoom3.alpha=world2D.btnZoomM.alpha=isZooming||isMapping?.4:1,!isZooming||isMapping&&1!==mappingTarget){if(isMapping&&(!isZooming||0===mappingTarget)){let t=.02;mapRatio+=t*(mappingTarget-mapRatio>0?1:-1),Math.abs(mappingTarget-mapRatio)<t&&(mapRatio=mappingTarget,isMapping=!1)}}else{let t=.02;3===zoomTaregt&&Math.abs(zoomTaregt-zoomMD)<1?t/=3:2===zoomTaregt&&Math.abs(zoomTaregt-zoomMD)<1&&(t/=2),zoomMD+=t*(zoomTaregt-zoomMD<0?-1:1),Math.abs(zoomTaregt-zoomMD)<t&&(zoomMD=zoomTaregt,isZooming=!1)}if(setControls(),setWorldSun(),setWorldEarth1(),setWorldEarth2(),setWorldMan(),setSkyBall(),setTheMap(),world2D.zoomBG.x=world2D.btnZoom0.x+zoomMD*(world2D.btnZoom3.x-world2D.btnZoom0.x)/3,world2D.zoomBG.y=world2D.btnZoom0.y+mapRatio*(world2D.btnZoomM.y-world2D.btnZoom0.y),world3D.cameraTarget.y=zoomMD<2+2/3?0:zoomMD>3?10:30*(zoomMD-2-2/3),theWorldSun.visible=theWorldEarth1.visible=theWorldEarth2.visible=theWorldMan.visible=!1,theWorldMap.mapPlane.visible=theWorldMap.man.visible=2===zoomMD,theStarBall.visible=mapRatio<1,zoomMD<1?(theWorldSun.visible=!0,theWorldSun.position.x=-zoomMD*theWorldSun.earthCon.position.x,theWorldSun.position.z=-zoomMD*theWorldSun.earthCon.position.z,theWorldSun.earthCon.scale.x=theWorldSun.earthCon.scale.y=theWorldSun.earthCon.scale.z=.4+.6*zoomMD,theSkyBall.position.x=theWorldSun.earthCon.position.x*(1-zoomMD),theSkyBall.position.y=theWorldSun.earthCon.position.y*(1-zoomMD),theSkyBall.position.z=theWorldSun.earthCon.position.z*(1-zoomMD),theSkyBall.scale.x=theSkyBall.scale.y=theSkyBall.scale.z=.205*theWorldSun.earthCon.scale.z,theSkyBall.sbConRZ.rotation.z=-obliquity,theSkyBall.sbConRY.rotation.y=theWorldSun.earth.rotation.y):zoomMD<2?(theWorldEarth1.visible=!0,theWorldEarth1.conRZ.rotation.z=obliquity*(zoomMD<1?0:zoomMD>1.5?1:2*(zoomMD-1)),theWorldEarth1.rotation.y=-thetaS%(2*Math.PI)*(zoomMD<1.5?0:zoomMD>2?1:2*(zoomMD-1.5)),theSkyBall.position.x=theSkyBall.position.y=theSkyBall.position.z=0,theSkyBall.scale.x=theSkyBall.scale.y=theSkyBall.scale.z=theWorldEarth1.earthCon.scale.z*(zoomMD<1.5?.205:zoomMD>2?.5:.205+.59*(zoomMD-1.5)),theSkyBall.sbConRZ.rotation.z=theWorldEarth1.conRZ.rotation.z-obliquity,theSkyBall.sbConRY.rotation.y=theWorldSun.earth.rotation.y+theWorldEarth1.rotation.y):zoomMD<3?(theWorldEarth2.visible=!theWorldMap.mapPlane.visible,theWorldMan.visible=!0,theWorldEarth2.tw2ConRZ.rotation.z=-(Math.PI/2-manLatitude)*(zoomMD<2?0:zoomMD>2+1/3?1:3*(zoomMD-2)),theWorldEarth2.tw2ConRY.rotation.y=+(manLongitude-Math.PI)*(zoomMD<2+1/3?0:zoomMD>2+2/3?1:3*(zoomMD-2-1/3)),theWorldEarth2.earth.scale.x=theWorldEarth2.earth.scale.y=theWorldEarth2.earth.scale.z=zoomMD<2+2/3?1:zoomMD>3?0:1-3*(zoomMD-2-2/3),theWorldEarth2.sunLight.scale.x=theWorldEarth2.sunLight.scale.y=theWorldEarth2.sunLight.scale.z=theWorldEarth2.earth.scale.x,theWorldMan.scale.x=theWorldMan.scale.y=theWorldMan.scale.z=1-theWorldEarth2.earth.scale.x==0?.001:1-theWorldEarth2.earth.scale.x,theWorldMan.position.y=10*theWorldEarth2.earth.scale.x,theSkyBall.scale.x=theSkyBall.scale.y=theSkyBall.scale.z=.5+.5*theWorldMan.scale.x,theSkyBall.sbConRZ.rotation.z=theWorldEarth2.tw2ConRZ.rotation.z,theSkyBall.sbConRY.rotation.y=theWorldEarth2.tw2ConRY.rotation.y):(theWorldEarth2.visible=!0,theWorldMan.visible=!0,theWorldEarth2.tw2ConRZ.rotation.z=-(Math.PI/2-manLatitude),theWorldEarth2.tw2ConRY.rotation.y=+(manLongitude-Math.PI),theWorldEarth2.earth.scale.x=theWorldEarth2.earth.scale.y=theWorldEarth2.earth.scale.z=.001,theWorldMan.scale.x=theWorldMan.scale.y=theWorldMan.scale.z=1,theWorldMan.position.y=0,theSkyBall.scale.x=theSkyBall.scale.y=theSkyBall.scale.z=1,theSkyBall.sbConRZ.rotation.z=theWorldEarth2.tw2ConRZ.rotation.z,theSkyBall.sbConRY.rotation.y=theWorldEarth2.tw2ConRY.rotation.y),theStarBall.position.x=world3D.camera.position.x,theStarBall.position.y=world3D.camera.position.y,theStarBall.position.z=world3D.camera.position.z,theStarBall.rotation.z=theSkyBall.sbConRZ.rotation.z,theStarBall.starSkyRY1.rotation.y=theStarBall.starSkyRY2.rotation.y=theSkyBall.sbConRY.rotation.y-timeNow/24/60/60*2*PI*(nnDaysPerYear+1)/nnDaysPerYear,theWorldMan.colorSky.visible){var s=theWorldMan._sunY>.1?.6:theWorldMan._sunY<-.1?0:.3+3*theWorldMan._sunY;theStarBall.starSkyRY1.material.color.setHSL(.666,.8,1-s/.6*.4),theStarBall.starSkyRY2.material.color.setHSL(.666,.8,1-s/.6*.4)}else theStarBall.starSkyRY1.material.color.setHSL(0,1,1);zoomMDOld=zoomMD,mapRatioOld=mapRatio,dateOld=dateNow,world3D.render(),world2D.stage.update()}function setWorldSun(){var t=theWorldSun,e=getRR(thetaB);t.earthCon.position.x=e*cos(thetaB),t.earthCon.position.z=-e*sin(thetaB),t.earth.rotation.y=thetaS,t.earthCon.rotation.z=-obliquity,t.earth.setMan();for(var o=0;o<=128;o++){var n=o/128*2*PI;n=Math.atan2(sin(n),cos(n)-eccentricity);var a=50*(2+eccentricity)*(1-eccentricity)/2*(1+eccentricity)/(1+eccentricity*cos(n));t.orbital.setPoint(o,a*cos(n),0,-a*sin(n))}t.orbital.update(),t.orbital.rotation.y=-pTheta0,t.sunLight.position.x=.4*e*cos(thetaB),t.sunLight.position.z=-.4*e*sin(thetaB),t.sunLight.position.y=0;var r=.2*e>10?10:.2*e;t.sunLight.setArrow(r*cos(thetaB),0,-r*sin(thetaB));for(o=0;o<4;o++){a=getRR(n=o*PI/2);var i=t["seasonArrow"+o],l=t["seasonText"+o],s=t["seasonTextRY"+o];s.position.x=i.position.x=a*cos(n),s.position.z=i.position.z=-a*sin(n),i.position.y=5,s.position.y=8,l.rotation.x=world3D.cameraTheta-PI/2,s.rotation.y=world3D.cameraPhi,s.visible=i.visible=world2D.controlPlanet.chSeason.checked}}function setWorldEarth1(){var t=theWorldEarth1;t.earth.rotation.y=thetaS,t.earthCon.rotation.z=-obliquity,t.earth.setMan(),t.sunLight.position.x=-20*cos(thetaB),t.sunLight.position.z=20*sin(thetaB),t.sunLight.position.y=0,t.sunLight.setArrow(10*cos(thetaB),0,-10*sin(thetaB))}function setWorldEarth2(){var t=theWorldEarth2;t.earth.setMan(),t.sunLight.position.x=20*cos(sunLatitude)*cos(sunLongitude),t.sunLight.position.z=20*cos(sunLatitude)*sin(sunLongitude),t.sunLight.position.y=20*sin(sunLatitude),t.sunLight.setArrow(-10*cos(sunLatitude)*cos(sunLongitude),-10*sin(sunLatitude),-10*cos(sunLatitude)*sin(sunLongitude))}function setWorldMan(){var t=theWorldMan;t.man.position.y=5;var e=manLongitude-sunLongitude,o=cos(sunLatitude)*sin(e),n=sin(sunLatitude)*cos(manLatitude)-cos(sunLatitude)*cos(e)*sin(manLatitude),a=sin(sunLatitude)*sin(manLatitude)+cos(sunLatitude)*cos(e)*cos(manLatitude);t.shadow.visible=a>0&&world2D.controlMan.chShadow.checked;var r=10*Math.sqrt(1-a*a)/a,i=Math.atan2(-o,-n);t.shadow.scale.x=r/10,t.shadow.scale.y=.12,t.shadow.scale.z=.12,t.shadow.position.x=.5*r*cos(i),t.shadow.position.z=.5*r*sin(i),t.shadow.position.y=0,t.shadow.rotation.y=-i,t.sunLight.visible=a>0&&world2D.controlMan.chShadow.checked,t.sunLight.position.x=10*n,t.sunLight.position.z=10*o,t.sunLight.position.y=10*a+10,t.sunLight.setArrow(-10*n,-10*a,-10*o);var l=a>.1?.6:a<-.1?0:.3+3*a;t.colorSky.material.color.setHSL(.666,.8,l),t.colorSky.visible=zoomMD>2.99,t._sunY=a}function setSkyBall(){var t=theSkyBall,e=t.rrSky;let o=getMapXYZfromLatitudeLongitude(sunLatitude,sunLongitude,e,2*mapRatio);t.sun.position.x=o[0],t.sun.position.y=o[1],t.sun.position.z=o[2],t.sun.visible=zoomMD>=1.5,timeView=60*world2D.controlSkyBall.nsViewTime.value*60,t.pts8.clear();for(var n=0;n<nnDaysPerYear;n++){var a=(r=calSunPosition(manLongitude/(2*Math.PI)*24*60*60+timeView+86400*n))[2];let o=getMapXYZfromLatitudeLongitude(r[3],a,e,2*mapRatio);t.pts8.addPoint(o[0],o[1],o[2])}t.pts8.visible=world2D.controlSkyBall.chPts8.checked,t.pts8.material.size=3*t.scale.z,t.pts8.update();for(n=0;n<24;n++){var r;a=(r=calSunPosition(timeNow+60*(n-12)*60))[2];let o=getMapXYZfromLatitudeLongitude(r[3],a,e,2*mapRatio);t.pts24.setPoint(n,o[0],o[1],o[2]),t.lns24.setPoint(n,o[0],o[1],o[2])}t.pts24.visible=t.lns24.visible=world2D.controlSkyBall.chPts24.checked,t.pts24.material.size=3.5*t.scale.z,t.pts24.update(),t.lns24.update(),t.ptsRecord.material.size=5*t.scale.z;for(n=0;n<t.nnLine;n++){var i=2*PI*n/(t.nnLine-1)-PI;let o=getMapXYZfromLatitudeLongitude(0,i,50,2*mapRatio);t.lnFixM.setPoint(n,o[0],o[1],o[2]);let a=getMapXYZfromLatitudeLongitude(obliquity,i,e,2*mapRatio);t.lnFixN.setPoint(n,a[0],a[1],a[2]),t.lnFixS.setPoint(n,a[0],-a[1],a[2])}if(t.lnFixM.update(),t.lnFixN.update(),t.lnFixS.update(),t.lnFix3.visible=world2D.controlSkyBall.chLFix3.checked,t.LLLine.visible=world2D.controlSkyBall.chLLLine.checked,mapRatioOld!==mapRatio){let e=t.LLLine.linesLA,o=t.LLLine.linesLO,a=0,r=t.rrSky;for(n=90;n>=-90;n-=30){var l=e[a];a++;for(var s=0;s<t.nnLine;s++){let e=getMapXYZfromLatitudeLongitude(n*PI/180,2*PI*s/(t.nnLine-1)-PI,r,2*mapRatio);l.setPoint(s,e[0],e[1],e[2])}l.update()}a=0;for(n=0;n<=360;n+=45){l=o[a];a++;for(s=0;s<t.nnLine;s++){let e=getMapXYZfromLatitudeLongitude(PI*s/(t.nnLine-1)-PI/2,n*PI/180-PI,r,2*mapRatio);l.setPoint(s,e[0],e[1],e[2])}l.update()}}}function getRR(t){return 50*(2+eccentricity)*(1-eccentricity)/2*(1+eccentricity)/(1+eccentricity*cos(t+pTheta0))}function setTheMap(){let t=theWorldMap;var e=t.matContext,o=new Image;if(o.src=pics.planet,e.drawImage(o,0,0),drawPlanetGLSL(),e.drawImage(t.matCanvasGLSL,0,0,512,512,0,0,1024,1024),t.mapTexture.needsUpdate=!0,mapRatioOld!==mapRatio){let e=32,o=32;for(var n=0;n<=o;n++)for(var a=0;a<=e/2;a++){let r=getMapXYZfromLatitudeLongitude(-(n-o/2)/o*PI,a/e*2*PI,10+15*mapRatio);t.mapGeometry.vertices[n*(e+1)+e/2+a].x=r[0],t.mapGeometry.vertices[n*(e+1)+e/2+a].y=r[1],t.mapGeometry.vertices[n*(e+1)+e/2+a].z=-r[2],t.mapGeometry.vertices[n*(e+1)+e/2-a].x=r[0],t.mapGeometry.vertices[n*(e+1)+e/2-a].y=r[1],t.mapGeometry.vertices[n*(e+1)+e/2-a].z=r[2]}t.mapGeometry.computeFaceNormals(),t.mapGeometry.computeVertexNormals(),t.mapGeometry.normalsNeedUpdate=!0,t.mapGeometry.verticesNeedUpdate=!0,t.mapGeometry.dynamic=!0}t.setMan(),theSkyBall.rotation.y=t.rotation.y=-.5*PI*mapRatio}function getMapXYZfromLatitudeLongitude(t,e,o,n){let a=o||20,r=n||0,i=(1-mapRatio)*a*sin(t)+mapRatio*t/PI*2*a,l=Math.abs(e)*a*((1-mapRatio)*cos(t)+.5*mapRatio),s=Math.abs(e)*(1-mapRatio),d=0,c=0;return s>0?(d=(1-mapRatio)*a*cos(t)-Math.tan(.5*s)*sin(s)*l/s,c=-Math.tan(.5*s)*(1+cos(s))*l/s*(e<0?1:-1)):(d=(1-mapRatio)*a*cos(t),c=-l*(e<0?1:-1)),[d+r,i,c]}function makeWorlds(){theWorldMap=new THREE.Object3D;var t=new THREE.Object3D,e=document.createElement("canvas");e.width=e.height=1024;var o=e.getContext("2d");o.imageSmoothingEnabled=!1;var n=new THREE.Texture(e);n.needsUpdate=!0;var a=new THREE.MeshBasicMaterial({map:n}),r=new THREE.PlaneGeometry(100,60,32,32),i=new THREE.Mesh(r,a);t.add(i),theWorldMap.add(t),scene.add(theWorldMap),theWorldMap.mapPlane=i,theWorldMap.mapConRX=t,theWorldMap.matContext=o,theWorldMap.mapTexture=n,theWorldMap.matCanvas2D=e,theWorldMap.mapGeometry=r,theWorldMap.mapMaterial=a,initMapGLSL();var l=new TEACHER.ObjSphere(.6,16750899);t.add(l),theWorldMap.man=l,theWorldMap.setMan=function(){let t=getMapXYZfromLatitudeLongitude(manLatitude,manLongitude,10+15*mapRatio);theWorldMap.man.position.x=t[0],theWorldMap.man.position.y=t[1],theWorldMap.man.position.z=t[2]},theWorldSun=new THREE.Object3D,scene.add(theWorldSun);var s=new TEACHER.ObjSphere(3,16776960),d=new THREE.Object3D,c=makeAnEarth();d.add(c);for(var h=new TEACHER.Line(16777215,4,129),m=0;m<=128;m++)h.addPoint(50*cos(m/128*2*Math.PI),0,50*sin(m/128*2*Math.PI));h.update();var E=new TEACHER.ObjArrow(1,16776960);theWorldSun.add(s).add(d).add(h).add(E),theWorldSun.earthCon=d,theWorldSun.earth=c,theWorldSun.rrE=50,theWorldSun.sunLight=E,theWorldSun.orbital=h,d.position.x=50,d.rotation.z=-obliquity;var u=new TEACHER.ObjArrow(.5,16751001),p=new TEACHER.ObjArrow(.5,16751001),w=new TEACHER.ObjArrow(.5,16751001),T=new TEACHER.ObjArrow(.5,16751001),y=new TEACHER.ObjTextPlane(6,6,"冬","z",16751001),M=new TEACHER.ObjTextPlane(6,6,"春","z",16751001),D=new TEACHER.ObjTextPlane(6,6,"夏","z",16751001),b=new TEACHER.ObjTextPlane(6,6,"秋","z",16751001),R=new THREE.Object3D,P=new THREE.Object3D,g=new THREE.Object3D,H=new THREE.Object3D;R.add(y),P.add(M),g.add(D),H.add(b),theWorldSun.add(u).add(p).add(w).add(T),theWorldSun.add(R).add(P).add(g).add(H),u.setArrow(0,-5,0),p.setArrow(0,-5,0),w.setArrow(0,-5,0),T.setArrow(0,-5,0),theWorldSun.seasonArrow0=u,theWorldSun.seasonArrow1=p,theWorldSun.seasonArrow2=w,theWorldSun.seasonArrow3=T,theWorldSun.seasonText0=y,theWorldSun.seasonText1=M,theWorldSun.seasonText2=D,theWorldSun.seasonText3=b,theWorldSun.seasonTextRY0=R,theWorldSun.seasonTextRY1=P,theWorldSun.seasonTextRY2=g,theWorldSun.seasonTextRY3=H,theWorldEarth1=new THREE.Object3D;var S=new THREE.Object3D;scene.add(theWorldEarth1);d=new THREE.Object3D,c=makeAnEarth();d.add(c);E=new TEACHER.ObjArrow(1,16776960);theWorldEarth1.add(S),S.add(d).add(E),theWorldEarth1.earthCon=d,theWorldEarth1.earth=c,theWorldEarth1.sunLight=E,theWorldEarth1.conRZ=S,d.rotation.z=-obliquity,theWorldEarth2=new THREE.Object3D,scene.add(theWorldEarth2);var x=new THREE.Object3D,L=new THREE.Object3D;c=makeAnEarth(),E=new TEACHER.ObjArrow(1,16776960);theWorldEarth2.add(x),x.add(L),L.add(c).add(E),theWorldEarth2.earth=c,theWorldEarth2.sunLight=E,theWorldEarth2.tw2ConRY=L,theWorldEarth2.tw2ConRZ=x,theWorldMan=new TEACHER.ObjPicCylinder(46,1,pics.ground);l=new TEACHER.ObjCylinder(.6,10,16750899);var C=new TEACHER.ObjBox(10,10,10,65793),v=(E=new TEACHER.ObjArrow(1,16776960),new TEACHER.ObjCylinder(46,5,26214));v.position.y=-3,theWorldMan.add(l).add(C).add(E).add(v),scene.add(theWorldMan),theWorldMan.man=l,theWorldMan.shadow=C,theWorldMan.sunLight=E;var A=new THREE.SphereGeometry(400,32,16),f=new THREE.MeshBasicMaterial({color:16711935,side:1}),O=new THREE.Mesh(A,f);theWorldMan.add(O),theWorldMan.colorSky=O,theSkyBall=makeAnSkyBall(),scene.add(theSkyBall),theStarBall=makeAnStarBall(),scene.add(theStarBall)}function makeAnEarth(){let t=new THREE.SphereGeometry(10,32,16),e=new THREE.Mesh(t,theWorldMap.mapMaterial);var o=new THREE.Object3D;o.add(e);var n=new TEACHER.ObjSphere(.6,16750899);return o.add(n),o.setMan=function(){n.position.x=10.2*cos(manLatitude)*cos(manLongitude),n.position.z=10.2*cos(manLatitude)*sin(manLongitude),n.position.y=10.2*sin(manLatitude)},o}function makeAnSkyBall(){var t=new THREE.Object3D,e=new THREE.Object3D,o=t;t.add(e);var n=new TEACHER.ObjSphere(3,16776960);e.add(n);for(var a=new THREE.Object3D,r=new TEACHER.Line(65535,3,128),i=new TEACHER.Line(65535,3,128),l=new TEACHER.Line(65535,3,128),s=0;s<128;s++){var d=2*Math.PI*s/127;l.addPoint(50*cos(d),0,50*sin(d)),r.addPoint(50*cos(obliquity)*cos(d),50*sin(obliquity),50*cos(obliquity)*sin(d)),i.addPoint(50*cos(obliquity)*cos(d),-50*sin(obliquity),50*cos(obliquity)*sin(d))}l.update(),r.update(),i.update(),a.add(l).add(r).add(i),e.add(a);var c=new THREE.Object3D;c.linesLA=[],c.linesLO=[];for(s=90;s>=-90;s-=30){for(var h=new TEACHER.Line(16777215,1.5,128),m=0;m<128;m++){d=2*Math.PI*m/127;h.addPoint(50*cos(d)*cos(s*Math.PI/180),50*sin(s*Math.PI/180),50*sin(d)*cos(s*Math.PI/180))}h.update(),c.add(h),c.linesLA.push(h)}for(s=0;s<=360;s+=45){for(h=new TEACHER.Line(16777215,1.5,128),m=0;m<128;m++){d=2*Math.PI*m/127;h.addPoint(50*cos(d)*cos(s*Math.PI/180),50*sin(d),50*cos(d)*sin(s*Math.PI/180))}h.update(),c.add(h),c.linesLO.push(h)}e.add(c);var E=new TEACHER.Points(16776960,3);for(s=0;s<nnDaysPerYear;s++)E.addPoint(0,0,0);e.add(E);var u=new TEACHER.Points(65280,3.5),p=new TEACHER.Line(65280,2.5);for(s=0;s<24;s++)u.addPoint(0,0,0),p.addPoint(0,0,0);e.add(u),e.add(p);var w=new TEACHER.Points(16777215,5);return e.add(w),o.pts8=E,o.pts24=u,o.lns24=p,o.ptsRecord=w,o.rrSky=50,o.nnLine=128,o.sun=n,o.lnFix3=a,o.lnFixN=r,o.lnFixS=i,o.lnFixM=l,o.LLLine=c,o.sbConRY=e,o.sbConRZ=t,o}function makeAnStarBall(){var t=new TEACHER.Points(16777215,5,300),e=new TEACHER.Points(16777215,2,500),o=new THREE.Object3D;o.add(t).add(e);for(var n=0;n<300;n++){let o=2*PI*Math.random(),n=Math.acos(Math.random()),a=250*cos(n)*(Math.random()>.5?1:-1);t.addPoint(250*sin(n)*cos(o),a,250*sin(n)*sin(o)),o=2*PI*Math.random(),n=Math.acos(Math.random()),a=250*cos(n)*(Math.random()>.5?1:-1),e.addPoint(250*sin(n)*cos(o),a,250*sin(n)*sin(o))}return t.update(),e.update(),o.starSkyRY1=t,o.starSkyRY2=e,o}function calSunPosition(t){var e=getThetaB(t),o=2*Math.PI*t/(86400*nnDaysPerYear)*(nnDaysPerYear+1),n=-cos(obliquity),a=-sin(obliquity),r=cos(obliquity)*n+sin(obliquity)*a,i=sin(-obliquity)*n+cos(obliquity)*a,l=cos(e)*r+0*sin(e),s=i,d=sin(-e)*r+0*cos(e),c=cos(obliquity)*l+sin(-obliquity)*s,h=sin(obliquity)*l+cos(obliquity)*s,m=d,E=cos(o)*c+sin(-o)*m,u=h,p=sin(o)*c+cos(o)*m,w=Math.asin(u);return[e,o,Math.atan2(p,E),w]}function getThetaB(t){for(var e,o=0,n=2*Math.PI-1e-11,a=getTimeFromTheta(o),r=getTimeFromTheta(n),i=0;r-a>1&&i<1e5;){if(a===t)e=o,i=100010;else if(r===t)e=n,i=100010;else{var l=.5*(o+n),s=getTimeFromTheta(l);s>t?(n=l,r=s):(o=l,a=s),e=l}i++}return e}function getTimeFromTheta(t){t+=pTheta0;var e=(2*Math.atan(Math.sqrt((1-eccentricity)/(1+eccentricity))*Math.tan(t/2))-eccentricity*Math.sqrt(1-eccentricity*eccentricity)*sin(t)/(1+eccentricity*cos(t)))*nnDaysPerYear*24*60*60/2/PI;return(e-=(2*Math.atan(Math.sqrt((1-eccentricity)/(1+eccentricity))*Math.tan(pTheta0/2))-eccentricity*Math.sqrt(1-eccentricity*eccentricity)*sin(pTheta0)/(1+eccentricity*cos(pTheta0)))*nnDaysPerYear*24*60*60/2/PI)<0&&(e+=24*nnDaysPerYear*60*60),e}function initMapGLSL(){let t=theWorldMap;var e,o,n,a=document.createElement("canvas");a.width=a.height=512,t.matCanvasGLSL=a,t.gl=a.getContext("experimental-webgl"),t.gl.viewport(0,0,t.gl.drawingBufferWidth,t.gl.drawingBufferHeight),t.buffer=t.gl.createBuffer(),t.gl.bindBuffer(t.gl.ARRAY_BUFFER,t.buffer),t.gl.bufferData(t.gl.ARRAY_BUFFER,new Float32Array([-1,-1,1,-1,-1,1,-1,1,1,-1,1,1]),t.gl.STATIC_DRAW),e=document.getElementById("2d-vertex-shader").text,o=t.gl.createShader(t.gl.VERTEX_SHADER),t.gl.shaderSource(o,e),t.gl.compileShader(o),e=document.getElementById("2d-fragment-shader").text,n=t.gl.createShader(t.gl.FRAGMENT_SHADER),t.gl.shaderSource(n,e),t.gl.compileShader(n),t.program=t.gl.createProgram(),t.gl.attachShader(t.program,o),t.gl.attachShader(t.program,n),t.gl.linkProgram(t.program),t.gl.useProgram(t.program)}function drawPlanetGLSL(){let t=theWorldMap.gl,e=theWorldMap.program,o=cos(sunLatitude)*cos(sunLongitude),n=sin(sunLatitude),a=cos(sunLatitude)*sin(sunLongitude),r=t.getUniformLocation(e,"sunX"),i=t.getUniformLocation(e,"sunY"),l=t.getUniformLocation(e,"sunZ");t.uniform1f(r,o),t.uniform1f(i,n),t.uniform1f(l,a);let s=t.getAttribLocation(e,"a_position");t.enableVertexAttribArray(s),t.vertexAttribPointer(s,2,t.FLOAT,!1,0,0),t.drawArrays(t.TRIANGLES,0,6)}function initControls(){world2D.titleMask.bbb.on("click",function(t){world2D.titleMask.visible=!1}),world2D.chPlanet.setLabel(" "),world2D.chSkyBall.setLabel(" "),world2D.chMan.setLabel(" "),world2D.chTimer.setLabel(" "),world2D.controlPlanet.slObliquity.minimum=world2D.controlPlanet.nsObliquity.minimum=0,world2D.controlPlanet.slObliquity.maximum=world2D.controlPlanet.nsObliquity.maximum=89,world2D.controlPlanet.slObliquity.value=world2D.controlPlanet.nsObliquity.value=23.5,world2D.controlPlanet.nsObliquity.dNumber=.5,world2D.controlPlanet.nsObliquity.digitN=1,world2D.controlPlanet.nsObliquity.dir="x",world2D.controlPlanet.slEccentricity.minimum=world2D.controlPlanet.nsEccentricity.minimum=0,world2D.controlPlanet.slEccentricity.maximum=world2D.controlPlanet.nsEccentricity.maximum=.95,world2D.controlPlanet.slEccentricity.value=world2D.controlPlanet.nsEccentricity.value=0,world2D.controlPlanet.nsEccentricity.dNumber=.01,world2D.controlPlanet.nsEccentricity.digitN=2,world2D.controlPlanet.nsEccentricity.dir="x",world2D.controlPlanet.slNNDaysPerYear.minimum=world2D.controlPlanet.nsNNDaysPerYear.minimum=10,world2D.controlPlanet.slNNDaysPerYear.maximum=world2D.controlPlanet.nsNNDaysPerYear.maximum=500,world2D.controlPlanet.slNNDaysPerYear.value=world2D.controlPlanet.nsNNDaysPerYear.value=360,world2D.controlPlanet.nsNNDaysPerYear.dir="x",world2D.controlPlanet.slPTheta0.minimum=world2D.controlPlanet.nsPTheta0.minimum=-180,world2D.controlPlanet.slPTheta0.maximum=world2D.controlPlanet.nsPTheta0.maximum=180,world2D.controlPlanet.slPTheta0.value=world2D.controlPlanet.nsPTheta0.value=0,world2D.controlPlanet.nsPTheta0.dir="x",world2D.controlPlanet.chSeason.setLabel(" "),world2D.controlPlanet.btnEarth.on("click",clickPlanet),world2D.controlPlanet.btnZero.on("click",clickPlanet),world2D.controlSkyBall.chLLLine.setLabel(" "),world2D.controlSkyBall.chLLLine.checked=!0,world2D.controlSkyBall.chLFix3.setLabel(" "),world2D.controlSkyBall.chPts24.setLabel(" "),world2D.controlSkyBall.chPts8.setLabel(" "),world2D.controlSkyBall.chAuto.setLabel(" "),world2D.controlSkyBall.nsViewTime.minimum=0,world2D.controlSkyBall.nsViewTime.maximum=23,world2D.controlSkyBall.nsViewTime.value=12,world2D.controlSkyBall.nsViewTime.setValue=setValue,world2D.controlSkyBall.btnRecord.on("click",addARecord),world2D.controlSkyBall.btnClear.on("click",function(t){theSkyBall.ptsRecord.clear()}),world2D.controlMan.nsManLo.minimum=-180,world2D.controlMan.nsManLo.maximum=180,world2D.controlMan.nsManLo.value=0,world2D.controlMan.nsManLo.dNumber=15,world2D.controlMan.nsManLo.dir="x",world2D.controlMan.nsManLa.minimum=-90,world2D.controlMan.nsManLa.maximum=90,world2D.controlMan.nsManLa.value=0,world2D.controlMan.nsManLa.dNumber=15,world2D.controlMan.nsManLa.dir="x",world2D.controlMan.chShadow.setLabel(" "),world2D.controlMan.chShadow.checked=!0,world2D.controlTimer.chStep.setLabel(" "),world2D.controlTimer.nsDD.minimum=0,world2D.controlTimer.nsDD.maximum=500,world2D.controlTimer.nsDD.value=1,world2D.controlTimer.nsDD.dir="y",world2D.controlTimer.nsHH.minimum=0,world2D.controlTimer.nsHH.maximum=23,world2D.controlTimer.nsHH.value=0,world2D.controlTimer.nsHH.dir="y",world2D.controlTimer.nsMM.minimum=0,world2D.controlTimer.nsMM.maximum=59,world2D.controlTimer.nsMM.value=0,world2D.controlTimer.nsMM.dir="y",world2D.controlTimer.nsSS.minimum=0,world2D.controlTimer.nsSS.maximum=59,world2D.controlTimer.nsSS.value=0,world2D.controlTimer.nsSS.dir="y",world2D.controlTimer.nsSS.setValue=setValue,world2D.controlTimer.nsMM.setValue=setValue,world2D.controlTimer.nsHH.setValue=setValue,world2D.controlTimer.nsDD.setValue=setValue,world2D.controlTimer.nsDD.btnUp.on("mousedown",timerDown),world2D.controlTimer.nsDD.btnDown.on("mousedown",timerDown),world2D.controlTimer.nsHH.btnUp.on("mousedown",timerDown),world2D.controlTimer.nsHH.btnDown.on("mousedown",timerDown),world2D.controlTimer.nsMM.btnUp.on("mousedown",timerDown),world2D.controlTimer.nsMM.btnDown.on("mousedown",timerDown),world2D.controlTimer.nsSS.btnUp.on("mousedown",timerDown),world2D.controlTimer.nsSS.btnDown.on("mousedown",timerDown),world2D.controlTimer.dtBtnDD.on("mousedown",timerDTDown),world2D.controlTimer.dtBtnHH.on("mousedown",timerDTDown),world2D.controlTimer.dtBtnMM.on("mousedown",timerDTDown),world2D.controlTimer.dtBtnSS.on("mousedown",timerDTDown),world2D.controlTimer.btnPlayStop.on("click",function(t){isPlay=!!isStep||!isPlay}),world2D.controlTimer.btnZero.on("click",function(t){world2D.controlTimer.nsSS.value=0,world2D.controlTimer.nsMM.value=0,world2D.controlTimer.nsHH.value=0,world2D.controlTimer.nsDD.value=0,needToSetTime=!0,isPlay=!1,isPlaying24=!1}),world2D.controlTimer.btnPlay24.on("click",function(t){isPlaying24||(needToSetTime=!1,isPlay=!1,isPlaying24=!0,timeTarget=timeNow+86400)})}function setControls(){world2D.controlPlanet.visible=world2D.chPlanet.checked,world2D.controlSkyBall.visible=world2D.chSkyBall.checked,world2D.controlMan.visible=world2D.chMan.checked,world2D.controlTimer.visible=world2D.chTimer.checked;for(var t=0;t<4;t++){var e;0===t?e="Obliquity":1===t?e="Eccentricity":2===t?e="NNDaysPerYear":3===t&&(e="PTheta0");var o=world2D.controlPlanet["ns"+e],n=world2D.controlPlanet["sl"+e];o.isSetting?n.value=o.value:n.isSetting&&(o.value=Math.round(n.value/o.dNumber)*o.dNumber,n.isSetting=!1)}}function clickBtnZoom(t){var e=t.target.name;isMapping||isZooming||("btnZoom0"===e?(zoomTaregt=0,mappingTarget=0):"btnZoom1"===e?(zoomTaregt=1,mappingTarget=0):"btnZoom2"===e?(zoomTaregt=2,mappingTarget=0):"btnZoom3"===e?(zoomTaregt=3,mappingTarget=0):"btnZoomM"===e&&(zoomTaregt=2,mappingTarget=1),isZooming=zoomTaregt!==zoomMD,isMapping=mappingTarget!==mapRatio)}function timerDown(t){isPlay=!1,needToSetTime=!0}function timerDTDown(t){var e=t.target.name;dtMD=e.charAt(5)}function setValue(t){var e="X";t.val<t.min?(t.val=t.max,e="N"):t.val>t.max&&(t.val=t.min,e="P");t.valueText.text=function(t,e){var o=t<0?"-":"";if(t=Math.abs(t),e>0){if((r=String(Math.round(t*Math.pow(10,e)))).length<e+1)for(var n=e+1-r.length,a=0;a<n;a++)r="0"+r;r=o+r.substr(0,r.length-e)+"."+r.substr(r.length-e)}else var r=o+String(Math.round(t));return r}(t.val,t.digN);var o=t.name.charAt(2);"P"===e?"S"===o?world2D.controlTimer.nsMM.value++:"M"===o?world2D.controlTimer.nsHH.value++:"H"===o&&world2D.controlTimer.nsDD.value++:"N"===e&&("S"===o?world2D.controlTimer.nsMM.value--:"M"===o?world2D.controlTimer.nsHH.value--:"H"===o&&world2D.controlTimer.nsDD.value--)}function addARecord(t){var e=theSkyBall.ptsRecord,o=getMapXYZfromLatitudeLongitude(sunLatitude,sunLongitude,20+30*mapRatio+30*(zoomMD-2),2*mapRatio);e.addPoint(o[0],o[1],o[2]),e.update()}function clickPlanet(t){var e=t.target.parent.name;"btnEarth"===e?setToPlanet(1):"btnZero"===e&&setToPlanet(0)}function setToPlanet(t){0===t?(world2D.controlPlanet.slEccentricity.value=world2D.controlPlanet.nsEccentricity.value=0,world2D.controlPlanet.slObliquity.value=world2D.controlPlanet.nsObliquity.value=0,world2D.controlPlanet.slPTheta0.value=world2D.controlPlanet.nsPTheta0.value=0,world2D.controlPlanet.slNNDaysPerYear.value=world2D.controlPlanet.nsNNDaysPerYear.value=360):1===t&&(world2D.controlPlanet.slEccentricity.value=world2D.controlPlanet.nsEccentricity.value=.02,world2D.controlPlanet.slObliquity.value=world2D.controlPlanet.nsObliquity.value=23.5,world2D.controlPlanet.slPTheta0.value=world2D.controlPlanet.nsPTheta0.value=13,world2D.controlPlanet.slNNDaysPerYear.value=world2D.controlPlanet.nsNNDaysPerYear.value=365)}MyJS.myResize();var TEACHER={ObjPlane:function(t,e,o,n,a){let r=this;r.mat=new TEACHER.MSMat(o,a),r.geo=new THREE.PlaneGeometry(t||10,e||10,1,1),r.mesh=new THREE.Mesh(r.geo,r.mat),"x"===n?r.mesh.rotation.y=.5*Math.PI:"y"===n&&(r.mesh.rotation.x=-.5*Math.PI),THREE.Object3D.call(this,r.geo,r.mat),r.add(r.mesh)}};TEACHER.ObjPlane.prototype=Object.create(THREE.Object3D.prototype),TEACHER.ObjPlane.prototype.constructor=TEACHER.ObjPlane,TEACHER.ObjCylinder=function(t,e,o,n,a,r){let i=this;i.mat=new TEACHER.MSMat(o,r),i.geo=new THREE.CylinderGeometry(t||10,t||10,e||10,32,2,n),i.mesh=new THREE.Mesh(i.geo,i.mat),"x"===a?i.mesh.rotation.z=-.5*Math.PI:"z"===a&&(i.mesh.rotation.x=.5*Math.PI),THREE.Object3D.call(this,i.geo,i.mat),i.add(i.mesh)},TEACHER.ObjCylinder.prototype=Object.create(THREE.Object3D.prototype),TEACHER.ObjCylinder.prototype.constructor=TEACHER.ObjCylinder,TEACHER.ObjSphere=function(t,e,o){let n=this;n.mat=new TEACHER.MSMat(e,o),n.geo=new THREE.SphereGeometry(t||10,32,16),n.mesh=new THREE.Mesh(n.geo,n.mat),THREE.Object3D.call(this,n.geo,n.mat),n.add(n.mesh)},TEACHER.ObjSphere.prototype=Object.create(THREE.Object3D.prototype),TEACHER.ObjSphere.prototype.constructor=TEACHER.ObjSphere,TEACHER.ObjBox=function(t,e,o,n,a){let r=this;r.mat=new TEACHER.MSMat(n,a),r.geo=new THREE.BoxGeometry(t||10,e||10,o||10),r.mesh=new THREE.Mesh(r.geo,r.mat),THREE.Object3D.call(this,r.geo,r.mat),r.add(r.mesh)},TEACHER.ObjBox.prototype=Object.create(THREE.Object3D.prototype),TEACHER.ObjBox.prototype.constructor=TEACHER.ObjBox,TEACHER.MSMat=function(t,e){THREE.MeshStandardMaterial.call(this,{color:t||16711935,roughness:.4,side:e||0})},TEACHER.MSMat.prototype=Object.create(THREE.MeshStandardMaterial.prototype),TEACHER.MSMat.prototype.constructor=TEACHER.MSMat,TEACHER.ObjPicPlane=function(t,e,o,n,a){let r=this,i=(new THREE.TextureLoader).load(o);r.mat=new THREE.MeshBasicMaterial({map:i,transparent:!0,side:a||0}),r.geo=new THREE.PlaneGeometry(t,e,1,1),r.mesh=new THREE.Mesh(r.geo,r.mat),"x"===n?r.mesh.rotation.y=.5*Math.PI:"y"===n&&(r.mesh.rotation.x=-.5*Math.PI),THREE.Object3D.call(this),r.add(r.mesh)},TEACHER.ObjPicPlane.prototype=Object.create(THREE.Object3D.prototype),TEACHER.ObjPicPlane.prototype.constructor=TEACHER.ObjPicPlane,TEACHER.ObjPicCylinder=function(t,e,o,n,a,r){let i=this,l=(new THREE.TextureLoader).load(o);i.mat=new THREE.MeshBasicMaterial({map:l,side:r||0}),i.geo=new THREE.CylinderGeometry(t||10,t||10,e||10,32,4,n),i.mesh=new THREE.Mesh(i.geo,i.mat),"x"===a?i.mesh.rotation.z=-.5*Math.PI:"z"===a?(i.mesh.rotation.y=.5*Math.PI,i.mesh.rotation.x=.5*Math.PI):"y"===a&&(i.mesh.rotation.y=.5*Math.PI),THREE.Object3D.call(this,i.geo,i.mat),i.add(i.mesh)},TEACHER.ObjPicCylinder.prototype=Object.create(THREE.Object3D.prototype),TEACHER.ObjPicCylinder.prototype.constructor=TEACHER.ObjPicCylinder,TEACHER.ObjPicSphere=function(t,e,o){let n=this,a=(new THREE.TextureLoader).load(e);n.mat=new THREE.MeshBasicMaterial({map:a,side:o||0}),n.geo=new THREE.SphereGeometry(t||10,32,16),n.mesh=new THREE.Mesh(n.geo,n.mat),THREE.Object3D.call(this,n.geo,n.mat),n.add(n.mesh)},TEACHER.ObjPicSphere.prototype=Object.create(THREE.Object3D.prototype),TEACHER.ObjPicSphere.prototype.constructor=TEACHER.ObjPicSphere,TEACHER.ObjArrow=function(t,e){let o=new THREE.MeshStandardMaterial({color:e||16711935,roughness:.4}),n=new THREE.ConeGeometry(t||10,40,32);this.ArrowHead=new THREE.Mesh(n,o),this.ArrowHead.position.y=80,n=new THREE.CylinderGeometry(.5*(t||10),.5*(t||10),60,32,2),this.ArrowBody=new THREE.Mesh(n,o),this.ArrowBody.position.y=30,THREE.Object3D.call(this),this.rotX=new THREE.Object3D,this.rotY=new THREE.Object3D,this.add(this.rotY),this.rotY.add(this.rotX),this.rotX.add(this.ArrowBody),this.rotX.add(this.ArrowHead)},TEACHER.ObjArrow.prototype=Object.create(THREE.Object3D.prototype),TEACHER.ObjArrow.prototype.constructor=TEACHER.ObjArrow,TEACHER.ObjArrow.prototype.setArrow=function(t,e,o){let n=t*t+e*e+o*o,a=Math.sqrt(n);n>0?(this.rotX.visible=!0,this.rotX.scale.y=a/100):this.rotX.visible=!1,this.rotX.rotation.x=Math.acos(e/a),this.rotY.rotation.y=Math.atan2(t,o)},TEACHER.ObjSpring=function(t,e,o,n,a){let r=t||20;this.L0=r;let i=[],l=n||5,s=e||5,d=o||.5;i.push(new THREE.Vector3(0,0,0)),i.push(new THREE.Vector3(0,.05*r,0));for(var c=0;c<=16*l;c++)i.push(new THREE.Vector3(s*Math.cos(2*c*Math.PI/16),r*(.05+.9*c/l/16),s*Math.sin(2*c*Math.PI/16)));i.push(new THREE.Vector3(0,.95*r,0)),i.push(new THREE.Vector3(0,r,0));let h=new THREE.CatmullRomCurve3(i),m=new THREE.MeshStandardMaterial({color:a||16711935,roughness:.4}),E=new THREE.TubeGeometry(h,500,d,12);this.mesh=new THREE.Mesh(E,m),THREE.Object3D.call(this),this.rotX=new THREE.Object3D,this.rotY=new THREE.Object3D,this.add(this.rotY),this.rotY.add(this.rotX),this.rotX.add(this.mesh)},TEACHER.ObjSpring.prototype=Object.create(THREE.Object3D.prototype),TEACHER.ObjSpring.prototype.constructor=TEACHER.ObjSpring,TEACHER.ObjSpring.prototype.setSpring=function(t,e,o){let n=t*t+e*e+o*o,a=Math.sqrt(n);n>0?(this.rotX.visible=!0,this.rotX.scale.y=a/this.L0):this.rotX.visible=!1,this.rotX.rotation.x=Math.acos(e/a),this.rotY.rotation.y=Math.atan2(t,o)},TEACHER.Points=function(t,e,o){let n=this,a=e||1,r=t||16711935,i=new THREE.Color(r);n.nnMax=o||1e4,n.nnNow=0,n.geometry=new THREE.BufferGeometry,n.positions=[],n.geometry.setAttribute("position",new THREE.Float32BufferAttribute(n.positions,3)),n.geometry.computeBoundingSphere();let l=new THREE.PointsMaterial({size:a,map:n.createCanvasMaterial("#"+i.getHexString(),64),transparent:!0,depthWrite:!1});THREE.Points.call(this,n.geometry,l)},TEACHER.Points.prototype=Object.create(THREE.Points.prototype),TEACHER.Points.prototype.constructor=TEACHER.Points,TEACHER.Points.prototype.createCanvasMaterial=function(t,e){var o=document.createElement("canvas");o.width=o.height=e;var n=o.getContext("2d");n.imageSmoothingEnabled=!1;var a=new THREE.Texture(o),r=e/2;return n.beginPath(),n.arc(r,r,e/2-3,0,2*Math.PI,!1),n.closePath(),n.fillStyle=t,n.fill(),a.needsUpdate=!0,a},TEACHER.Points.prototype.addPoint=function(t,e,o){let n=this;n.nnNow<n.nnMax?n.nnNow++:(log("TEACHER.Points 到達最大點數"),n.positions.shift(),n.positions.shift(),n.positions.shift()),n.positions.push(t,e,o)},TEACHER.Points.prototype.clear=function(){this.positions=[],this.nnNow=0,this.update()},TEACHER.Points.prototype.setPoint=function(t,e,o,n){let a=this;t>a.nnMax?log("輸入的n值大於TEACHER.Points 最大點數 nnMax"):t>a.nnNow?log("輸入的n值大於TEACHER.Points 現在點數 nnNow"):(a.positions[3*t]=e,a.positions[3*t+1]=o,a.positions[3*t+2]=n)},TEACHER.Points.prototype.getPoint=function(t){let e=this,o=new THREE.Vector3;return t>e.nnMax?log("輸入的n值大於TEACHER.Points 最大點數 nnMax"):t>e.nnNow?log("輸入的n值大於TEACHER.Points 現在點數 nnNow"):(o.x=e.positions[3*t],o.y=e.positions[3*t+1],o.z=e.positions[3*t+2]),o},TEACHER.Points.prototype.update=function(){this.geometry.setAttribute("position",new THREE.Float32BufferAttribute(this.positions,3)),this.geometry.computeBoundingSphere(),this.geometry.attributes.position.needsUpdate=!0},TEACHER.Line=function(t,e,o){let n=this;n.nnMax=o||1e4,n.lineWidth=e||1,n.nnNow=0;var a=new THREE.LineMaterial({color:t||16711935,linewidth:e||1});a.resolution.set(window.innerWidth,window.innerHeight),n.geometry=new THREE.LineGeometry,n.positions=new Float32Array(3*n.nnMax),n.geometry.setPositions(n.positions),THREE.Line2.call(this,n.geometry,a)},TEACHER.Line.prototype=Object.create(THREE.Line2.prototype),TEACHER.Line.prototype.constructor=TEACHER.Line,TEACHER.Line.prototype.addPoint=function(t,e,o){let n=this;if(n.nnNow<n.nnMax)n.nnNow++;else{log("TEACHER.Line 到達最大點數");for(var a=0;a<n.nnMax-1;a++)n.positions[3*a]=n.positions[3*a+3],n.positions[3*a+1]=n.positions[3*a+4],n.positions[3*a+2]=n.positions[3*a+5]}for(a=n.nnNow;a<=n.nnMax;a++)n.positions[3*(a-1)]=t,n.positions[3*(a-1)+1]=e,n.positions[3*(a-1)+2]=o},TEACHER.Line.prototype.clear=function(){this.positions=new Float32Array(3*this.nnMax),this.nnNow=0,this.update()},TEACHER.Line.prototype.setPoint=function(t,e,o,n){let a=this;t>a.nnMax?log("輸入的n值大於TEACHER.Line 最大點數 nnMax"):t>a.nnNow?log("輸入的n值大於TEACHER.Line 現在點數 nnNow"):(a.positions[3*t]=e,a.positions[3*t+1]=o,a.positions[3*t+2]=n)},TEACHER.Line.prototype.getPoint=function(t){let e=this,o=new THREE.Vector3;return t>e.nnMax?log("輸入的n值大於TEACHER.Line 最大點數 nnMax"):t>e.nnNow?log("輸入的n值大於TEACHER.Line 現在點數 nnNow"):(o.x=e.positions[3*t],o.y=e.positions[3*t+1],o.z=e.positions[3*t+2]),o},TEACHER.Line.prototype.update=function(){let t=this,e=t.getPoint(t.nnNow-1);for(var o=t.nnNow;o<=t.nnMax;o++)t.positions[3*o]=e.x,t.positions[3*o+1]=e.y,t.positions[3*o+2]=e.z;t.geometry.setPositions(t.positions)},TEACHER.ObjTextPlane=function(t,e,o,n,a,r){let i=this,l=Math.round(Math.log2(t/e)),s=$("<canvas>").attr("width",String(128*Math.pow(2,l))).attr("height","128");i.stage=new createjs.Stage(s[0]);let d=new createjs.Container;if(r){let t=new createjs.Shape,e=new THREE.Color(r);t.graphics.c().f("#"+e.getHexString()).dr(0,0,128*Math.pow(2,l),128),d.addChild(t)}i.ctext=new createjs.Text;let c=new THREE.Color(a||16777215);i.ctext.color="#"+c.getHexString(),i.ctext.font="96px Arial",i.ctext.text=o||"",i.ctext.textAlign="center",i.ctext.textBaseline="middle",i.ctext.x=128*Math.pow(2,l)/2,i.ctext.y=64,d.addChild(i.ctext),i.stage.addChild(d),i.stage.update(),i.texture=new THREE.Texture(s[0]);var h=new THREE.MeshBasicMaterial({map:i.texture,transparent:!0}),m=new THREE.PlaneGeometry(t||10,e||10,1,1);i.texture.needsUpdate=!0,i.plane1=new THREE.Mesh(m,h),i.plane2=new THREE.Mesh(m,h),i.plane2.rotation.y=Math.PI;let E=new THREE.Object3D;E.add(i.plane1).add(i.plane2),"x"===n?E.rotation.y=.5*Math.PI:"y"===n&&(E.rotation.x=-.5*Math.PI),THREE.Object3D.call(this),i.add(E)},TEACHER.ObjTextPlane.prototype=Object.create(THREE.Object3D.prototype),TEACHER.ObjTextPlane.prototype.constructor=TEACHER.ObjTextPlane,TEACHER.ObjTextPlane.prototype.setText=function(t){let e=this;e.ctext.text=t,e.stage.update(),e.texture.needsUpdate=!0},TEACHER.ObjGraph=function(t,e,o,n,a,r,i){let l=this;l.objCon=new THREE.Object3D,l._xMin=t||0,l._xMax=e||10,l._yMin=o||0,l._yMax=n||10,l.divXN=5,l.divYN=4,l.frameMat=new THREE.LineBasicMaterial({color:a||16777215});for(var s=[],d=0;d<=l.divXN;d++)s.push(new THREE.Vector3(20*d-50,0,0)),s.push(new THREE.Vector3(20*d-50,50,0));for(var c=0;c<=l.divYN;c++)s.push(new THREE.Vector3(-50,12.5*c,0)),s.push(new THREE.Vector3(50,12.5*c,0));let h=(new THREE.BufferGeometry).setFromPoints(s);l.frame=new THREE.LineSegments(h,l.frameMat),l.objCon.add(l.frame),l.labelXMin=new TEACHER.ObjTextPlane(20,5,String(l._xMin),"z",a||16777215),l.labelXMin.position.x=-50,l.labelXMin.position.y=-3,l.objCon.add(l.labelXMin),l.labelXMax=new TEACHER.ObjTextPlane(20,5,String(l._xMax),"z",a||16777215),l.labelXMax.position.x=50,l.labelXMax.position.y=-3,l.objCon.add(l.labelXMax),l.labelYMin=new TEACHER.ObjTextPlane(20,5,String(l._yMin),"z",a||16777215),l.labelYMin.position.x=-53,l.labelYMin.position.y=0,l.objCon.add(l.labelYMin),l.labelYMax=new TEACHER.ObjTextPlane(20,5,String(l._yMax),"z",a||16777215),l.labelYMax.position.x=-53,l.labelYMax.position.y=50,l.objCon.add(l.labelYMax),l.labelX=new TEACHER.ObjTextPlane(24,7,"x","z",a||16777215),l.labelX.position.x=60,l.labelX.position.y=4,l.labelX.position.z=1,l.labelY=new TEACHER.ObjTextPlane(24,7,"y","z",a||16777215),l.labelY.position.x=-60,l.labelY.position.y=25,l.labelY.position.z=1,l.labelY.rotation.z=Math.PI/2,l.labelTitle=new TEACHER.ObjTextPlane(40,10,"y-x","z",a||16777215),l.labelTitle.position.y=53,l.labelTitle.position.z=1,l.objCon.add(l.labelX).add(l.labelY).add(l.labelTitle),l._lineColor=r,l._nnMax=i,l.line=new TEACHER.Line(l._lineColor||16776960,2,l._nnMax),l.objCon.add(l.line),l.changeScale(),THREE.Object3D.call(this),l.add(l.objCon)},TEACHER.ObjGraph.prototype=Object.create(THREE.Object3D.prototype),TEACHER.ObjGraph.prototype.constructor=TEACHER.ObjGraph,Object.defineProperty(TEACHER.ObjGraph.prototype,"xMin",{get:function(){return this._xMin},set:function(t){this._xMin=t,this.changeScale()}}),Object.defineProperty(TEACHER.ObjGraph.prototype,"xMax",{get:function(){return this._xMax},set:function(t){this._xMax=t,this.changeScale()}}),Object.defineProperty(TEACHER.ObjGraph.prototype,"yMin",{get:function(){return this._yMin},set:function(t){this._yMin=t,this.changeScale()}}),Object.defineProperty(TEACHER.ObjGraph.prototype,"yMax",{get:function(){return this._yMax},set:function(t){this._yMax=t,this.changeScale()}}),TEACHER.ObjGraph.prototype.addPoint=function(t,e){this.line.addPoint(t,e,0),this.line.update()},TEACHER.ObjGraph.prototype.clear=function(){this.line.clear()},TEACHER.ObjGraph.prototype.changeScale=function(){let t=this;t.line.scale.x=100/(t._xMax-t._xMin),t.line.scale.y=50/(t._yMax-t._yMin),t.line.position.x=-50-t._xMin*t.line.scale.x,t.line.position.y=-t._yMin*t.line.scale.y,t.labelXMin.setText(t._xMin),t.labelXMax.setText(t._xMax),t.labelYMin.setText(t._yMin),t.labelYMax.setText(t._yMax)},TEACHER.ObjGraph.prototype.setLabel=function(t,e,o){this.labelTitle.setText(t||"y-x"),this.labelY.setText(e||"y"),this.labelX.setText(o||"x")};var logo=new TEACHER.ObjPicPlane(100,12.5,pics.logo,"z",2);function getMouse3D(t,e){let o,n=t||"y",a=new THREE.Vector3;"x"===n?o=new THREE.Vector3(1,0,0):"y"===n?o=new THREE.Vector3(0,1,0):"z"===n?o=new THREE.Vector3(0,0,1):log("錯誤!!");let r=new THREE.Vector2;return r.x=world2D.stage.mouseX/1600*2-1,r.y=-world2D.stage.mouseY/900*2+1,world3D.raycaster.setFromCamera(r,world3D.camera),world3D.raycaster.ray.intersectPlane(new THREE.Plane(o),a),a}logo.position.z=-80,logo.position.y=6.25,world3D.scene.add(logo),init();