var MyJS=MyJS||{};(function(){function a(){this.raysInverse=[],this.raysUnsolved=[],this.raysSolved=[],this.surfaceSegments=[],this.surfaceArcs=[],this.xMax=1e4,this.xMin=-1e4,this.yMax=1e4,this.yMin=-1e4,this.isReflection=!1}function b(){for(var a=[],c=380;780>=c;c++){var d=0,e=0,f=0;380<=c&&440>=c?(d=-1*(c-440)/60,e=0,f=1):440<c&&490>=c?(d=0,e=(c-440)/50,f=1):490<c&&510>=c?(d=0,e=1,f=-1*(c-510)/20):510<c&&580>=c?(d=(c-510)/70,e=1,f=0):580<c&&645>=c?(d=1,e=-1*(c-645)/65,f=0):645<c&&780>=c&&(d=1,e=0,f=0);var h=645<c?.3+.7*(780-c)/135:420>c?.3+.7*(c-380)/40:1;var i=Math.round(255*h*d),j=Math.round(255*h*e),k=Math.round(255*h*f);a.push([i,j,k])}return a}function c(a){var b=a*a;return Math.sqrt(1+1.03961212*b/(b-6000.69867)+.231792344*b/(b-20017.9144)+1.01046945*b/(b-103560653))}function d(a,b,c,d){this.xA=a,this.yA=b,this.theta=c,this.xB=a,this.yB=b,this.lambda=d||550,this.nx=Math.cos(this.theta),this.ny=Math.sin(this.theta),this.solved=!1,this.generation=0}function e(a,b,c){this.x0=a,this.y0=b,this.theta=c,this.rayIn,this.bengingType="",this.nIn=1}function f(a){return(a%h+h)%h}var g=Math.PI,h=2*Math.PI,j=1e-9;j=5,MyJS.OpticsSystem=a,a.prototype.solveAll=function(){for(var a=this,b=0;0<a.raysUnsolved.length&&1e4>b;){b++;var c=a.raysUnsolved.shift(),d=!1,h=10*a.xMax,k=new e;k.rayIn=c;for(var l=a.surfaceSegments.length,m=0;m<l;m++){var n=a.surfaceSegments[m],o=a.findRaySegmentT1T2(c,n);if(o[0]>j&&o[0]<h&&0<o[1]&&1>o[1]){d=!0,h=o[0],k.x0=c.xA+c.nx*h,k.y0=c.yA+c.ny*h,k.bendingType=n.mType;var p=Math.atan2(n.yB-n.yA,n.xB-n.xA);k.theta=f(p+.5*g),c.xB=k.x0,c.yB=k.y0}}for(var l=a.surfaceArcs.length,m=0;m<l;m++){var q=a.surfaceArcs[m],o=a.findRayAcrT1T2(c,q);o[0]>j&&o[0]<h&&(d=!0,h=o[0],k.x0=c.xA+c.nx*h,k.y0=c.yA+c.ny*h,k.bendingType=q.mType,k.theta=f(o[1]),0>q.io&&(k.theta=f(k.theta+g)),c.xB=k.x0,c.yB=k.y0)}for(var l=a.parabolaMirrors.length,m=0;m<l;m++){var r=a.parabolaMirrors[m],o=a.findRayParabolaT1T2(c,r);o[0]>j&&o[0]<h&&(d=!0,h=o[0],k.x0=c.xA+c.nx*h,k.y0=c.yA+c.ny*h,k.bendingType="reflection",k.theta=f(Math.atan(2*r.ff/(o[1]-r.y0))+g/2),c.xB=k.x0,c.yB=k.y0)}for(var l=a.ellipseMirrors.length,m=0;m<l;m++){var s=a.ellipseMirrors[m],o=a.findRayEllipseT1T2(c,s);o[0]>j&&o[0]<h&&(d=!0,h=o[0],k.x0=c.xA+c.nx*h,k.y0=c.yA+c.ny*h,k.bendingType="reflection",k.theta=f(Math.atan(-(k.x0-s.x0)/(k.y0-s.y0)*Math.pow(s.bb/s.aa,2))+g/2),c.xB=k.x0,c.yB=k.y0)}for(var l=a.hyperbolaMirrors.length,m=0;m<l;m++){var t=a.hyperbolaMirrors[m],o=a.findRayHyperbolaT1T2(c,t);o[0]>j&&o[0]<h&&(d=!0,h=o[0],k.x0=c.xA+c.nx*h,k.y0=c.yA+c.ny*h,k.bendingType="reflection",k.theta=f(Math.atan((k.x0-t.x0)/(k.y0-t.y0)*Math.pow(t.bb/t.aa,2))+g/2),c.xB=k.x0,c.yB=k.y0)}if(!d)c.xB=c.xA+c.nx*h,c.yB=c.yA+c.ny*h;else{if("refraction"===k.bendingType)var u=k.refraction(a.isReflection);else if("reflection"===k.bendingType)if(opticsLab.isOnlyOnce&&1>c.generation||!opticsLab.isOnlyOnce&&10>c.generation)var u=k.reflection();else var u=[];for(var l=u.length,m=0;m<l;m++)a.raysUnsolved.push(u[m])}a.raysSolved.push(c)}},a.prototype.findRayAcrT1T2=function(a,b){var c=a.xA,d=a.yA,e=a.nx,g=a.ny,h=b.xC,i=b.yC,k=b.RR,l=b.theta0,m=b.thetaDelta,n=e*e+g*g,o=2*(e*(c-h)+g*(d-i)),p=Math.pow(c-h,2)+Math.pow(d-i,2)-Math.pow(k,2),q=o*o-4*n*p,r=-1,s=-1;if(0<q){var t=(Math.sqrt(q)-o)/2/n,u=(-Math.sqrt(q)-o)/2/n,v=Math.atan2(d-i+g*t,c-h+e*t),w=Math.atan2(d-i+g*u,c-h+e*u);v=f(v-l),w=f(w-l),v<m&&t>j&&(r=t,s=v),w<m&&u>j&&u<t&&(r=u,s=w)}return s=f(s+l),[r,s]},a.prototype.findRaySegmentT1T2=function(a,b){var c=a.xA,d=a.yA,e=a.nx,f=a.ny,g=b.xA,h=b.yA,i=b.xB,j=b.yB;return[((c-g)*(j-h)-(d-h)*(i-g))/(f*(i-g)-e*(j-h)),(f*(c-g)-e*(d-h))/(f*(i-g)-e*(j-h))]},a.prototype.findRayParabolaT1T2=function(a,b){var c,d,e=a.xA,f=a.yA,g=a.nx,h=a.ny,i=b.x0,k=b.y0,l=b.ff;if(.001>Math.abs(h/g)){d=f;var m=Math.pow(f-k,2)/4/l+i;c=Math.abs(m-e)*(0<(m-e)*g?1:-1)}else if(!(.001>Math.abs(g/h))){var n=1/4/l,o=-k/2/l-g/h,p=o*o-4*n*(k*k/4/l+i-e+g*f/h);if(0<=p){var q=(-o+Math.sqrt(p))/2/n,r=(-o-Math.sqrt(p))/2/n,s=Math.pow(q-k,2)/4/l+i,t=Math.pow(r-k,2)/4/l+i,u=Math.sqrt((s-e)*(s-e)+(q-f)*(q-f))*(0<(s-e)*g?1:-1),v=Math.sqrt((t-e)*(t-e)+(r-f)*(r-f))*(0<(t-e)*g?1:-1);u>j&&(v>u||v<j)?(c=u,d=q):v>j&&(u>v||u<j)?(c=v,d=r):c=d=-1e5}else c=d=-1e5}else if(e>i){var q=k+Math.sqrt(4*l*(e-i)),r=k-Math.sqrt(4*l*(e-i)),u=Math.abs(q-f)*(0<(q-f)*h?1:-1),v=Math.abs(r-f)*(0<(r-f)*h?1:-1);u>j&&(v>u||v<j)?(c=u,d=q):v>j&&(u>v||u<j)?(c=v,d=r):(log("\u4E0D\u53EF\u80FD!!!"),c=d=-1e5)}else c=d=-1e5;return[c,d]},a.prototype.findRayEllipseT1T2=function(a,b){var c,d,e=a.xA,f=a.yA,g=a.nx,h=a.ny,i=b.x0,k=b.y0,l=b.aa,m=b.bb;if(1e-4>Math.abs(h/g)){var n=1/l/l,o=-2*i/l/l,p=Math.pow(i/l,2)+Math.pow((f-k)/m,2)-1,q=o*o-4*n*p;if(0<=q){var r=(-o+Math.sqrt(q))/2/n,s=(-o-Math.sqrt(q))/2/n,t=f,u=f,v=Math.sqrt((r-e)*(r-e)+(t-f)*(t-f))*(0<(r-e)*g?1:-1),w=Math.sqrt((s-e)*(s-e)+(u-f)*(u-f))*(0<(s-e)*g?1:-1);v>j&&(w>v||w<j)?(c=v,d=Math.atan2(t-k,r-i)):w>j&&(v>w||v<j)?(c=w,d=Math.atan2(u-k,s-i)):(log("aaaaaaaaaaa"),c=d=-1e5)}else c=d=-1e5}else if(1e-4>Math.abs(g/h)){var n=1/m/m,o=-2*k/m/m,p=Math.pow(k/m,2)+Math.pow((e-i)/l,2)-1,q=o*o-4*n*p;if(0<=q){var t=(-o+Math.sqrt(q))/2/n,u=(-o-Math.sqrt(q))/2/n,r=e,s=e,v=Math.sqrt((r-e)*(r-e)+(t-f)*(t-f))*(0<(t-f)*h?1:-1),w=Math.sqrt((s-e)*(s-e)+(u-f)*(u-f))*(0<(u-f)*h?1:-1);v>j&&(w>v||w<j)?(c=v,d=Math.atan2(t-k,r-i)):w>j&&(v>w||v<j)?(c=w,d=Math.atan2(u-k,s-i)):(log("bbbb"),log("tRay1="+v+"   ,tRay2="+w),log("tt="+tt),c=d=-1e5)}else c=d=-1e5}else{var n=Math.pow(1/l,2)+Math.pow(h/g/m,2),o=-2*i/l/l-2*e*Math.pow(h/g/m,2)+2*(f-k)*h/g/m/m,p=Math.pow(i/l,2)+Math.pow(e*h/m/g,2)+(f-k)*(f-k-2*e*h/g)/m/m-1,q=o*o-4*n*p;if(0<=q){var r=(-o+Math.sqrt(q))/2/n,s=(-o-Math.sqrt(q))/2/n,t=(r-e)*h/g+f,u=(s-e)*h/g+f,v=Math.sqrt((r-e)*(r-e)+(t-f)*(t-f))*(0<(r-e)*g?1:-1),w=Math.sqrt((s-e)*(s-e)+(u-f)*(u-f))*(0<(s-e)*g?1:-1);v>j&&(w>v||w<j)?(c=v,d=Math.atan2(t-k,r-i)):w>j&&(v>w||v<j)?(c=w,d=Math.atan2(u-k,s-i)):c=d=-1e5}else c=d=-1e5}return[c,d]},a.prototype.findRayHyperbolaT1T2=function(a,b){var c,d,e=a.xA,f=a.yA,g=a.nx,h=a.ny,i=b.x0,k=b.y0,l=b.aa,m=b.bb;if(1e-4>Math.abs(h/g)){var n=1/l/l,o=-2*i/l/l,p=Math.pow(i/l,2)-Math.pow((f-k)/m,2)-1,q=o*o-4*n*p;if(0<=q){var r=(-o+Math.sqrt(q))/2/n,s=(-o-Math.sqrt(q))/2/n,t=f,u=f,v=Math.sqrt((r-e)*(r-e)+(t-f)*(t-f))*(0<(r-e)*g?1:-1),w=Math.sqrt((s-e)*(s-e)+(u-f)*(u-f))*(0<(s-e)*g?1:-1);v>j&&(w>v||w<j)?(c=v,d=Math.atan2(t-k,r-i)):w>j&&(v>w||v<j)?(c=w,d=Math.atan2(u-k,s-i)):(log("aaaaaaaaaaa"),c=d=-1e5)}else c=d=-1e5}else if(1e-4>Math.abs(g/h)){var n=-1/m/m,o=2*k/m/m,p=-Math.pow(k/m,2)+Math.pow((e-i)/l,2)-1,q=o*o-4*n*p;if(0<=q){var t=(-o+Math.sqrt(q))/2/n,u=(-o-Math.sqrt(q))/2/n,r=e,s=e,v=Math.sqrt((r-e)*(r-e)+(t-f)*(t-f))*(0<(t-f)*h?1:-1),w=Math.sqrt((s-e)*(s-e)+(u-f)*(u-f))*(0<(u-f)*h?1:-1);v>j&&(w>v||w<j)?(c=v,d=Math.atan2(t-k,r-i)):w>j&&(v>w||v<j)?(c=w,d=Math.atan2(u-k,s-i)):(log("bbbb"),log("tRay1="+v+"   ,tRay2="+w),log("tt="+tt),c=d=-1e5)}else c=d=-1e5}else{var n=Math.pow(1/l,2)-Math.pow(h/g/m,2),o=-2*i/l/l+2*e*Math.pow(h/g/m,2)-2*(f-k)*h/g/m/m,p=Math.pow(i/l,2)-Math.pow(e*h/m/g,2)-(f-k)*(f-k-2*e*h/g)/m/m-1,q=o*o-4*n*p;if(0<=q){var r=(-o+Math.sqrt(q))/2/n,s=(-o-Math.sqrt(q))/2/n,t=(r-e)*h/g+f,u=(s-e)*h/g+f,v=Math.sqrt((r-e)*(r-e)+(t-f)*(t-f))*(0<(r-e)*g?1:-1),w=Math.sqrt((s-e)*(s-e)+(u-f)*(u-f))*(0<(s-e)*g?1:-1);v>j&&(w>v||w<j)?(c=v,d=Math.atan2(t-k,r-i)):w>j&&(v>w||v<j)?(c=w,d=Math.atan2(u-k,s-i)):c=d=-1e5}else c=d=-1e5}return[c,d]},a.prototype.labmdaToColor=function(a){var c=this;c.isColorTableReady||(c.colorTable=b(),c.isColorTableReady=!0);var d=[0,0,0];return 380<=a&&780>=a&&(d=c.colorTable[Math.round(a-380)]),d},MyJS.OneRay=d,MyJS.OneSegment=function(a,b,c,d,e){this.mType=a,this.xA=b,this.yA=c,this.xB=d,this.yB=e},MyJS.OneArc=function(a,b,c,d,e,f,g){this.mType=a,this.xC=b,this.yC=c,this.RR=d,this.theta0=e,this.thetaDelta=f,this.io=g},e.prototype.refraction=function(a=!1){log("\u4E0D\u61C9\u8A72\u6298\u5C04");var b=this;b.nIn=c(b.rayIn.lambda);var e=[],h=!1,i=f(b.rayIn.theta-b.theta);if(i>.5*g&&i<1.5*g){var j=Math.sin(i)/b.nIn;if(-1>j&&1<j)h=!0;else var k=g-Math.asin(j)}else{var j=Math.sin(i)*b.nIn;if(-1>j||1<j)h=!0;else var k=f(Math.asin(j))}if(!h){var l=new d(b.x0,b.y0,f(k+b.theta),b.rayIn.lambda);e.push(l)}if(a||h){var m=f(g-i),n=new d(b.x0,b.y0,f(m+b.theta),b.rayIn.lambda);e.push(n)}return e},e.prototype.reflection=function(){var a=this,b=[],c=f(a.rayIn.theta-a.theta),e=f(g-c),h=new d(a.x0,a.y0,f(e+a.theta),a.rayIn.lambda);if(h.generation=a.rayIn.generation+1,b.push(h),opticsLab.isInverse){var h=new d(a.x0,a.y0,f(e+a.theta)+g,a.rayIn.lambda);h.generation=a.rayIn.generation+1,h.xB=h.xA+1e6*h.nx,h.yB=h.yA+1e6*h.ny,opticsLab.opticsSystem.raysInverse.push(h)}return b}})();var MyJS=MyJS||{};(function(){function a(){this.lightSources=[],this.lambdaNow=550,this.prisms=[],this.glassBalls=[],this.realLenses=[],this.prisms=[],this.glassBalls=[],this.realLenses=[],this.parabolaMirrors=[],this.ellipseMirrors=[],this.hyperbolaMirrors=[],this.isOnlyOnce=!1,this.isInverse=!1,this.opticsSystem=new MyJS.OpticsSystem}var b=Math.PI,c=2*Math.PI,d=300,e=300,f=10;MyJS.OpticsLab=a,a.prototype.myUpdate=function(){var a=this,b=this.opticsSystem;b.solveAll()},a.prototype.prepareRays=function(){var a=this,b=this.opticsSystem;b.raysInverse=[],b.raysUnsolved=[],b.raysSolved=[];for(var d,e=a.lightSources.length,f=0;f<e;f++)if(d=a.lightSources[f],"point"===d.sType)for(var g=d.numLines,h=0;h<g;h++)b.raysUnsolved.push(new MyJS.OneRay(d.x0,d.y0,h*c/g,a.lambdaNow));else if("single"===d.sType)b.raysUnsolved.push(new MyJS.OneRay(d.x0,d.y0,d.theta,a.lambdaNow));else if("white"===d.sType)for(var g=200,h=0;h<g;h++)b.raysUnsolved.push(new MyJS.OneRay(d.x0,d.y0,d.theta,380+400*(h/g)))},a.prototype.prepareSegmentsAndArcs=function(){var a=this,c=this.opticsSystem;c.surfaceSegments=[],c.surfaceArcs=[];for(var g=a.prisms.length,h=0;h<g;h++)for(var k=a.prisms[h],l=k.segments.length,m=k.x0,n=k.y0,o=k.theta,p=Math.cos(o),q=Math.sin(o),r=k.segments[l-1][0],s=k.segments[l-1][1],t=0;t<l;t++){var u=k.segments[t][0],v=k.segments[t][1],w=m+r*p-s*q,x=n+s*p+r*q,y=m+u*p-v*q,z=n+v*p+u*q;c.surfaceSegments.push(new MyJS.OneSegment("refraction",w,x,y,z,1.5)),r=u,s=v}for(var g=a.glassBalls.length,h=0;h<g;h++){var A=a.glassBalls[h],m=A.x0,n=A.y0,B=A.RR;c.surfaceArcs.push(new MyJS.OneArc("refraction",m,n,B,0,b,1))}for(var C,g=a.realLenses.length,h=0;h<g;h++)if(C=a.realLenses[h],"convexLens"===C.mType){var D=Math.sqrt(d*d-e*e/4),E=Math.atan2(e/2,D),F=-D*Math.cos(C.theta),G=-D*Math.sin(C.theta);c.surfaceArcs.push(new MyJS.OneArc("refraction",C.x0+F,C.y0+G,d,-E+C.theta,2*E,1)),c.surfaceArcs.push(new MyJS.OneArc("refraction",C.x0-F,C.y0-G,d,-E+C.theta+b,2*E,1))}else if("concaveLens"===C.mType){var D=d+f/2,E=Math.asin(e/2/d),F=-D*Math.cos(C.theta),G=-D*Math.sin(C.theta);c.surfaceArcs.push(new MyJS.OneArc("refraction",C.x0+F,C.y0+G,d,-E+C.theta,2*E,-1)),c.surfaceArcs.push(new MyJS.OneArc("refraction",C.x0-F,C.y0-G,d,-E+C.theta+b,2*E,-1));var D=d*(1-Math.cos(E))+f/2,H=-e/2*Math.sin(C.theta),I=e/2*Math.cos(C.theta),F=-D*Math.cos(C.theta),G=-D*Math.sin(C.theta);c.surfaceSegments.push(new MyJS.OneSegment("refraction",C.x0+H+F,C.y0+I+G,C.x0+H-F,C.y0+I-G)),c.surfaceSegments.push(new MyJS.OneSegment("refraction",C.x0-H-F,C.y0-I-G,C.x0-H+F,C.y0-I+G))}else if("convexMirror"===C.mType){var E=Math.asin(e/2/d),F=d*Math.cos(C.theta),G=d*Math.sin(C.theta);c.surfaceArcs.push(new MyJS.OneArc("reflection",C.x0+F,C.y0+G,d,-E+C.theta+b,2*E,1))}else if("concaveMirror"===C.mType){var E=Math.asin(e/2/d),F=-d*Math.cos(C.theta),G=-d*Math.sin(C.theta);c.surfaceArcs.push(new MyJS.OneArc("reflection",C.x0+F,C.y0+G,d,-E+C.theta,2*E,-1))}c.parabolaMirrors=a.parabolaMirrors,c.ellipseMirrors=a.ellipseMirrors,c.hyperbolaMirrors=a.hyperbolaMirrors},MyJS.OneParabolaMiror=function(a,b,c){this.x0=a,this.y0=b,this.ff=c},MyJS.OneEllipseMiror=function(a,b,c,d){this.x0=a,this.y0=b,this.aa=c,this.bb=d},MyJS.OneHyperbolaMiror=function(a,b,c,d){this.x0=a,this.y0=b,this.aa=c,this.bb=d}})();var fps=60,comp=AdobeAn.getComposition("98EA1A955B63F6489D0F00F6BFD1C4DE"),lib=comp.getLibrary(),myAnimate=new lib.myAnimate,canvas=$("<canvas>").attr("width","1600px").attr("height","900px");$("#mainAnimation").append(canvas);var stage=new createjs.Stage(canvas[0]);stage.enableMouseOver(1e3/60),stage.addChild(myAnimate),createjs.Touch.enable(stage),stage.update();var opticsLab,ctx,tt=90,mirrorMD="parabola",lightMD="line",dragingWho="X",deltaBX=0,deltaBY=50;init();function init(){myAnimate.helper.visible=!1,myAnimate.ligBtnB.scaleX=myAnimate.ligBtnB.scaleY=.7,opticsLab=new MyJS.OpticsLab,opticsLab.mama=this,opticsLab.opticsSystem.mama=this,myAnimate.rb01.setLabel("\u62CB\u7269\u9762\u93E1"),myAnimate.rb02.setLabel("\u6A62\u5713\u9762\u93E1"),myAnimate.rb03.setLabel("\u96D9\u66F2\u9762\u93E1"),myAnimate.rb04.setLabel("\u5E73\u884C\u5149"),myAnimate.rb05.setLabel("\u9EDE\u5149\u6E90"),myAnimate.rb01.on("click",clickRB),myAnimate.rb01.checked=!0,myAnimate.rb04.checked=!0,myAnimate.rb02.on("click",clickRB),myAnimate.rb03.on("click",clickRB),myAnimate.rb04.on("click",clickRB),myAnimate.rb05.on("click",clickRB),myAnimate.ligBtnA.on("mousedown",downLigBtn),myAnimate.ligBtnB.on("mousedown",downLigBtn),myAnimate.ligBtnA.on("pressmove",moveLigBtn),myAnimate.ligBtnB.on("pressmove",moveLigBtn),myAnimate.on("pressup",myUp),myAnimate.sl01.label.visible=!1,myAnimate.sl01.valueText.visible=!1,myAnimate.sl01.minimum=2,myAnimate.sl01.maximum=8,myAnimate.sl01.value=4,myAnimate.ch01.setLabel("\u53EA\u53CD\u5C04\u4E00\u6B21"),myAnimate.ch01.checked=!0,myAnimate.ch02.setLabel("\u53CD\u5411\u5EF6\u4F38"),setInterval(tick,1e3/fps)}function tick(){tt--,60>tt&&0<tt&&(myAnimate.title.x=130*(60-tt)/60+800*tt/60,myAnimate.title.y=30*(60-tt)/60+450*tt/60,myAnimate.title.scaleX=myAnimate.title.scaleY=.8*(60-tt)/60+4.5*tt/60),myAnimate.ligBtnB.visible="line"===lightMD;var b=opticsLab,c=opticsLab.opticsSystem;if(b.isOnlyOnce=myAnimate.ch01.checked,myAnimate.ch02.visible=myAnimate.ch01.checked,b.isInverse=myAnimate.ch02.checked&&myAnimate.ch01.checked,c.raysInverse=[],c.raysUnsolved=[],c.raysSolved=[],"line"===lightMD){var d=Math.pow(2,Math.round(myAnimate.sl01.value-2)),e=Math.atan2(myAnimate.ligBtnA.x-myAnimate.ligBtnB.x,myAnimate.ligBtnB.y-myAnimate.ligBtnA.y);if(1===d){var f=new MyJS.OneRay(myAnimate.ligBtnA.x,myAnimate.ligBtnA.y,e,b.lambdaNow);c.raysUnsolved.push(f)}else for(var g=0;g<d;g++){var h=myAnimate.ligBtnB.x-myAnimate.ligBtnA.x,j=myAnimate.ligBtnB.y-myAnimate.ligBtnA.y,k=myAnimate.ligBtnA.x+2*h*(g-(d-1)/2)/(d-1),l=myAnimate.ligBtnA.y+2*j*(g-(d-1)/2)/(d-1),f=new MyJS.OneRay(k,l,e,b.lambdaNow);c.raysUnsolved.push(f)}}else if("point"===lightMD)for(var d=Math.pow(2,Math.round(myAnimate.sl01.value)),g=0;g<d;g++){var e=2*(g/d)*Math.PI+Math.PI/d,k=myAnimate.ligBtnA.x,l=myAnimate.ligBtnA.y,f=new MyJS.OneRay(k,l,e,b.lambdaNow);c.raysUnsolved.push(f)}b.parabolaMirrors=[],b.ellipseMirrors=[],b.hyperbolaMirrors=[],"parabola"===mirrorMD?b.parabolaMirrors.push(new MyJS.OneParabolaMiror(600,450,100)):"ellipse"===mirrorMD?b.ellipseMirrors.push(new MyJS.OneEllipseMiror(700,450,500,400)):"hyperbola"===mirrorMD&&b.hyperbolaMirrors.push(new MyJS.OneHyperbolaMiror(700,450,100,200)),c.parabolaMirrors=b.parabolaMirrors,c.ellipseMirrors=b.ellipseMirrors,c.hyperbolaMirrors=b.hyperbolaMirrors,opticsLab.myUpdate(),ctx=myAnimate.drawBmp.ctx,ctx.globalCompositeOperation="source-over",ctx.clearRect(0,0,1600,900),ctx.strokeStyle="rgb(255,255,255)",ctx.lineWidth=6,ctx.globalCompositeOperation="lighter",ctx.beginPath();var d=opticsLab.opticsSystem.parabolaMirrors.length;if(0<d)for(var m,g=0;g<d;g++){m=opticsLab.opticsSystem.parabolaMirrors[g];for(var l=0;900>l;l++)ctx.lineTo(Math.pow(l-m.y0,2)/4/m.ff+m.x0,l)}var d=opticsLab.opticsSystem.ellipseMirrors.length;if(0<d)for(var n,g=0;g<d;g++){n=opticsLab.opticsSystem.ellipseMirrors[g];for(var e=0;e<2*Math.PI;e+=2*Math.PI/128){var k=n.x0+n.aa*Math.cos(e),l=n.y0+n.bb*Math.sin(e);ctx.lineTo(k,l)}}var d=opticsLab.opticsSystem.hyperbolaMirrors.length;if(0<d)for(var o,g=0;g<d;g++){o=opticsLab.opticsSystem.hyperbolaMirrors[g];for(var k,l=o.y0-1e3;l<o.y0+1e3;l+=2)k=o.x0+o.aa*Math.sqrt(1+Math.pow((l-o.y0)/o.bb,2)),ctx.lineTo(k,l);for(var k,l=o.y0+1e3;l>o.y0-1e3;l-=2)k=o.x0-o.aa*Math.sqrt(1+Math.pow((l-o.y0)/o.bb,2)),ctx.lineTo(k,l)}ctx.stroke(),ctx.strokeStyle="rgba(255,255,255,255)",ctx.lineWidth=16,ctx.globalCompositeOperation="lighter",ctx.beginPath(),"point"===lightMD||"line"===lightMD&&(ctx.lineCap="round",ctx.moveTo(2*myAnimate.ligBtnA.x-myAnimate.ligBtnB.x,2*myAnimate.ligBtnA.y-myAnimate.ligBtnB.y),ctx.lineTo(myAnimate.ligBtnB.x,myAnimate.ligBtnB.y)),ctx.stroke();var p=opticsLab.opticsSystem.raysSolved,d=p.length,q=1;ctx.lineWidth=5;for(var g=0;g<d;g++){var a=p[g],r=opticsLab.opticsSystem.labmdaToColor(0===a.generation?500:630-50/a.generation);ctx.strokeStyle="rgb("+Math.round(r[0]*q)+","+Math.round(r[1]*q)+","+Math.round(r[2]*q)+")",ctx.beginPath(),ctx.moveTo(a.xA,a.yA),ctx.lineTo(a.xB,a.yB),ctx.stroke()}var s=opticsLab.opticsSystem.raysInverse,d=s.length;ctx.lineWidth=4;for(var g=0;g<d;g++){var a=s[g],r=[128,128,128];ctx.strokeStyle="rgb("+Math.round(r[0]*q)+","+Math.round(r[1]*q)+","+Math.round(r[2]*q)+")",ctx.beginPath(),ctx.moveTo(a.xA,a.yA),ctx.lineTo(a.xB,a.yB),ctx.stroke()}stage.update()}MyJS.myResize();function clickRB(a){var b=a.target.parent.name;("rb01"===b||"rb02"===b||"rb03"===b)&&(myAnimate.rb01.checked=myAnimate.rb02.checked=myAnimate.rb03.checked=!1,"rb01"===b?(myAnimate.rb01.checked=!0,mirrorMD="parabola"):"rb02"===b?(myAnimate.rb02.checked=!0,mirrorMD="ellipse"):"rb03"===b&&(myAnimate.rb03.checked=!0,mirrorMD="hyperbola")),("rb04"===b||"rb05"===b)&&(myAnimate.rb04.checked=myAnimate.rb05.checked=!1,"rb04"===b?(myAnimate.rb04.checked=!0,lightMD="line"):"rb05"===b&&(myAnimate.rb05.checked=!0,lightMD="point"))}function downLigBtn(a){var b=a.target.name;"ligBtnA"===b?dragingWho="A":"ligBtnB"===b&&(dragingWho="B")}function moveLigBtn(){var a=stage.mouseX,b=stage.mouseY;if("A"===dragingWho)myAnimate.ligBtnA.x=a,myAnimate.ligBtnA.y=b,myAnimate.ligBtnB.x=a+deltaBX,myAnimate.ligBtnB.y=b+deltaBY;else if("B"===dragingWho){myAnimate.ligBtnB.x=a,myAnimate.ligBtnB.y=b,deltaBX=myAnimate.ligBtnB.x-myAnimate.ligBtnA.x,deltaBY=myAnimate.ligBtnB.y-myAnimate.ligBtnA.y;var c=Math.atan2(deltaBX,deltaBY);.05>Math.abs(c/Math.PI-Math.round(c/Math.PI))&&(myAnimate.ligBtnB.x=myAnimate.ligBtnA.x,deltaBX=0)}}function myUp(){dragingWho="X"}class OneRaySource{constructor(a,b,c,d){this.xA=a,this.yA=b,this.theta=c,this.nn=d}}