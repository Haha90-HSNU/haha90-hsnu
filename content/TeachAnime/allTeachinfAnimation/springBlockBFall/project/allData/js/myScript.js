"use strict";var ballA,ballB,spring,ballC,ballD,wireL,wireR,wireM,fps=60,log=console.log,gameMD=0,mA=10,mB=10,kk=10,dt=.01,L0=20,x0=15,gg=5,isPlay=!1,isStep=!1,cameraFollowRatio=1;function init(){ballA=new TEACHER.ObjBox(10,10,10,65535),ballB=new TEACHER.ObjBox(10,10,10,52224),spring=new TEACHER.ObjSpring(L0,3,.3,8,16776960),(wireL=new TEACHER.ObjCylinder(.5,20,16750848)).position.y=990,ballA.position.x=ballB.position.x=wireL.position.x=spring.position.x=-x0,scene.add(ballA).add(ballB).add(spring).add(wireL),ballC=new TEACHER.ObjBox(10,10,10,65535),ballD=new TEACHER.ObjBox(10,10,10,52224),wireM=new TEACHER.ObjCylinder(.5,20,16750848),(wireR=new TEACHER.ObjCylinder(.5,20,16750848)).position.y=990,ballC.position.x=ballD.position.x=wireM.position.x=wireR.position.x=x0,scene.add(ballC).add(ballD).add(wireM).add(wireR);var t=new TEACHER.ObjBox(60,5,20,10053120);t.position.y=1002.5,scene.add(t);for(var e=0;e<10;e++){var o=new TEACHER.ObjPicPlane(100,100,pics.ground,"z");o.position.y=100*e+65,o.position.z=-5,scene.add(o)}world2D.btn01.setLabel("切斷繩"),world2D.btn01.on("click",clickBtn01),world2D.btn02.setLabel("重來"),world2D.btn02.on("click",clickBtn02),world2D.ch01.setLabel("跟隨"),world2D.ch01.checked=!0,world2D.ch02.setLabel("慢動作"),world2D.ch02.checked=!0,world2D.sl01.visible=world2D.sl02.visible=world2D.sl03.visible=!1,world2D.btnUp.visible=world2D.btnDown.visible=world2D.btnLeft.visible=world2D.btnRight.visible=!1,world2D.slCameraRR.value=125,initGame(),setInterval(tick,1e3/fps)}function tick(){if(0===gameMD);else if(1===gameMD){let o=world2D.ch02.checked?1:10;for(var t=0;t<o;t++){var e=kk*(ballA.position.y-ballB.position.y-10-L0);if(ballA.vy-=(e/mA+gg)*dt,ballB.vy+=(e/mB-gg)*dt,ballA.position.y+=ballA.vy*dt,ballB.position.y+=ballB.vy*dt,ballB.position.y<5&&ballB.vy<0&&(ballB.position.y=5,ballB.vy*=-.5),ballA.position.y-ballB.position.y<10&&ballA.vy-ballB.vy<0){let t=.5*(ballA.vy+ballB.vy);ballA.vy=1.5*t-.5*ballA.vy,ballB.vy=1.5*t-.5*ballB.vy,ballA.position.y=ballB.position.y+10}if(ballC.vy-=gg*dt,ballD.vy-=gg*dt,ballC.position.y+=ballC.vy*dt,ballD.position.y+=ballD.vy*dt,ballD.position.y<5&&(ballD.position.y=5,ballD.vy*=-.5,wireM.visible=!1),ballC.position.y-ballD.position.y<10&&ballC.vy-ballD.vy<0){let t=.5*(ballC.vy+ballD.vy);ballC.vy=1.5*t-.5*ballC.vy,ballD.vy=1.5*t-.5*ballD.vy,ballC.position.y=ballD.position.y+10,wireM.visible=!1}}}spring.position.y=ballA.position.y-5,spring.setSpring(0,ballB.position.y-ballA.position.y+10,0),wireL.visible=wireR.visible=0===gameMD,wireM.position.y=ballC.position.y-5-10,world2D.ch01.checked&&cameraFollowRatio<1?(cameraFollowRatio+=.01)>1&&(cameraFollowRatio=1):!world2D.ch01.checked&&cameraFollowRatio>0&&(cameraFollowRatio-=.01)<0&&(cameraFollowRatio=0),world3D.cameraTarget.y=.5*(ballA.position.y+ballB.position.y)*cameraFollowRatio,world3D.render(),world2D.stage.update()}function initGame(){ballA.position.y=975,ballB.position.y=965-L0-mB*gg/kk,spring.position.y=ballA.position.y-5,ballA.vy=ballB.vy=0,spring.setSpring(0,ballB.position.y-ballA.position.y+10,0),ballC.position.y=975,ballD.position.y=945,wireM.position.y=ballC.position.y-5-10,ballC.vy=ballD.vy=0,wireM.visible=!0,world2D.btn01.visible=!0,world2D.btn02.visible=!1}function clickBtn01(t){0===gameMD&&(gameMD=1,world2D.btn01.visible=!1,world2D.btn02.visible=!0)}function clickBtn02(t){gameMD=0,initGame()}MyJS.myResize();var TEACHER={ObjPlane:function(t,e,o,i,n){let a=this;a.mat=new TEACHER.MSMat(o,n),a.geo=new THREE.PlaneGeometry(t||10,e||10,1,1),a.mesh=new THREE.Mesh(a.geo,a.mat),"x"===i?a.mesh.rotation.y=.5*Math.PI:"y"===i&&(a.mesh.rotation.x=-.5*Math.PI),THREE.Object3D.call(this,a.geo,a.mat),a.add(a.mesh)}};TEACHER.ObjPlane.prototype=Object.create(THREE.Object3D.prototype),TEACHER.ObjPlane.prototype.constructor=TEACHER.ObjPlane,TEACHER.ObjCylinder=function(t,e,o,i,n,a){let r=this;r.mat=new TEACHER.MSMat(o,a),r.geo=new THREE.CylinderGeometry(t||10,t||10,e||10,32,2,i),r.mesh=new THREE.Mesh(r.geo,r.mat),"x"===n?r.mesh.rotation.z=-.5*Math.PI:"z"===n&&(r.mesh.rotation.x=.5*Math.PI),THREE.Object3D.call(this,r.geo,r.mat),r.add(r.mesh)},TEACHER.ObjCylinder.prototype=Object.create(THREE.Object3D.prototype),TEACHER.ObjCylinder.prototype.constructor=TEACHER.ObjCylinder,TEACHER.ObjSphere=function(t,e,o){let i=this;i.mat=new TEACHER.MSMat(e,o),i.geo=new THREE.SphereGeometry(t||10,32,16),i.mesh=new THREE.Mesh(i.geo,i.mat),THREE.Object3D.call(this,i.geo,i.mat),i.add(i.mesh)},TEACHER.ObjSphere.prototype=Object.create(THREE.Object3D.prototype),TEACHER.ObjSphere.prototype.constructor=TEACHER.ObjSphere,TEACHER.ObjBox=function(t,e,o,i,n){let a=this;a.mat=new TEACHER.MSMat(i,n),a.geo=new THREE.BoxGeometry(t||10,e||10,o||10),a.mesh=new THREE.Mesh(a.geo,a.mat),THREE.Object3D.call(this,a.geo,a.mat),a.add(a.mesh)},TEACHER.ObjBox.prototype=Object.create(THREE.Object3D.prototype),TEACHER.ObjBox.prototype.constructor=TEACHER.ObjBox,TEACHER.MSMat=function(t,e){THREE.MeshStandardMaterial.call(this,{color:t||16711935,roughness:.4,side:e||0})},TEACHER.MSMat.prototype=Object.create(THREE.MeshStandardMaterial.prototype),TEACHER.MSMat.prototype.constructor=TEACHER.MSMat,TEACHER.ObjPicPlane=function(t,e,o,i,n){let a=this,r=(new THREE.TextureLoader).load(o);a.mat=new THREE.MeshBasicMaterial({map:r,transparent:!0,side:n||0}),a.geo=new THREE.PlaneGeometry(t,e,1,1),a.mesh=new THREE.Mesh(a.geo,a.mat),"x"===i?a.mesh.rotation.y=.5*Math.PI:"y"===i&&(a.mesh.rotation.x=-.5*Math.PI),THREE.Object3D.call(this),a.add(a.mesh)},TEACHER.ObjPicPlane.prototype=Object.create(THREE.Object3D.prototype),TEACHER.ObjPicPlane.prototype.constructor=TEACHER.ObjPicPlane,TEACHER.ObjPicCylinder=function(t,e,o,i,n,a){let r=this,l=(new THREE.TextureLoader).load(o);r.mat=new THREE.MeshBasicMaterial({map:l,side:a||0}),r.geo=new THREE.CylinderGeometry(t||10,t||10,e||10,32,4,i),r.mesh=new THREE.Mesh(r.geo,r.mat),"x"===n?r.mesh.rotation.z=-.5*Math.PI:"z"===n?(r.mesh.rotation.y=.5*Math.PI,r.mesh.rotation.x=.5*Math.PI):"y"===n&&(r.mesh.rotation.y=.5*Math.PI),THREE.Object3D.call(this,r.geo,r.mat),r.add(r.mesh)},TEACHER.ObjPicCylinder.prototype=Object.create(THREE.Object3D.prototype),TEACHER.ObjPicCylinder.prototype.constructor=TEACHER.ObjPicCylinder,TEACHER.ObjPicSphere=function(t,e,o){let i=this,n=(new THREE.TextureLoader).load(e);i.mat=new THREE.MeshBasicMaterial({map:n,side:o||0}),i.geo=new THREE.SphereGeometry(t||10,32,16),i.mesh=new THREE.Mesh(i.geo,i.mat),THREE.Object3D.call(this,i.geo,i.mat),i.add(i.mesh)},TEACHER.ObjPicSphere.prototype=Object.create(THREE.Object3D.prototype),TEACHER.ObjPicSphere.prototype.constructor=TEACHER.ObjPicSphere,TEACHER.ObjArrow=function(t,e){let o=new THREE.MeshStandardMaterial({color:e||16711935,roughness:.4}),i=new THREE.ConeGeometry(t||10,40,32);this.ArrowHead=new THREE.Mesh(i,o),this.ArrowHead.position.y=80,i=new THREE.CylinderGeometry(.5*(t||10),.5*(t||10),60,32,2),this.ArrowBody=new THREE.Mesh(i,o),this.ArrowBody.position.y=30,THREE.Object3D.call(this),this.rotX=new THREE.Object3D,this.rotY=new THREE.Object3D,this.add(this.rotY),this.rotY.add(this.rotX),this.rotX.add(this.ArrowBody),this.rotX.add(this.ArrowHead)},TEACHER.ObjArrow.prototype=Object.create(THREE.Object3D.prototype),TEACHER.ObjArrow.prototype.constructor=TEACHER.ObjArrow,TEACHER.ObjArrow.prototype.setArrow=function(t,e,o){let i=t*t+e*e+o*o,n=Math.sqrt(i);i>0?(this.rotX.visible=!0,this.rotX.scale.y=n/100):this.rotX.visible=!1,this.rotX.rotation.x=Math.acos(e/n),this.rotY.rotation.y=Math.atan2(t,o)},TEACHER.ObjSpring=function(t,e,o,i,n){let a=t||20;this.L0=a;let r=[],l=i||5,s=e||5,E=o||.5;r.push(new THREE.Vector3(0,0,0)),r.push(new THREE.Vector3(0,.05*a,0));for(var p=0;p<=16*l;p++)r.push(new THREE.Vector3(s*Math.cos(2*p*Math.PI/16),a*(.05+.9*p/l/16),s*Math.sin(2*p*Math.PI/16)));r.push(new THREE.Vector3(0,.95*a,0)),r.push(new THREE.Vector3(0,a,0));let c=new THREE.CatmullRomCurve3(r),b=new THREE.MeshStandardMaterial({color:n||16711935,roughness:.4}),y=new THREE.TubeGeometry(c,500,E,12);this.mesh=new THREE.Mesh(y,b),THREE.Object3D.call(this),this.rotX=new THREE.Object3D,this.rotY=new THREE.Object3D,this.add(this.rotY),this.rotY.add(this.rotX),this.rotX.add(this.mesh)},TEACHER.ObjSpring.prototype=Object.create(THREE.Object3D.prototype),TEACHER.ObjSpring.prototype.constructor=TEACHER.ObjSpring,TEACHER.ObjSpring.prototype.setSpring=function(t,e,o){let i=t*t+e*e+o*o,n=Math.sqrt(i);i>0?(this.rotX.visible=!0,this.rotX.scale.y=n/this.L0):this.rotX.visible=!1,this.rotX.rotation.x=Math.acos(e/n),this.rotY.rotation.y=Math.atan2(t,o)},TEACHER.Points=function(t,e,o){let i=this,n=e||1,a=t||16711935,r=new THREE.Color(a);i.nnMax=o||1e4,i.nnNow=0,i.geometry=new THREE.BufferGeometry,i.positions=[],i.geometry.setAttribute("position",new THREE.Float32BufferAttribute(i.positions,3)),i.geometry.computeBoundingSphere();let l=new THREE.PointsMaterial({size:n,map:i.createCanvasMaterial("#"+r.getHexString(),64),transparent:!0,depthWrite:!1});THREE.Points.call(this,i.geometry,l)},TEACHER.Points.prototype=Object.create(THREE.Points.prototype),TEACHER.Points.prototype.constructor=TEACHER.Points,TEACHER.Points.prototype.createCanvasMaterial=function(t,e){var o=document.createElement("canvas");o.width=o.height=e;var i=o.getContext("2d");i.imageSmoothingEnabled=!1;var n=new THREE.Texture(o),a=e/2;return i.beginPath(),i.arc(a,a,e/2-3,0,2*Math.PI,!1),i.closePath(),i.fillStyle=t,i.fill(),n.needsUpdate=!0,n},TEACHER.Points.prototype.addPoint=function(t,e,o){let i=this;i.nnNow<i.nnMax?i.nnNow++:(log("TEACHER.Points 到達最大點數"),i.positions.shift(),i.positions.shift(),i.positions.shift()),i.positions.push(t,e,o),i.geometry.setAttribute("position",new THREE.Float32BufferAttribute(i.positions,3)),i.geometry.computeBoundingSphere(),i.geometry.attributes.position.needsUpdate=!0},TEACHER.Points.prototype.clear=function(){let t=this;t.positions=[],t.geometry.setAttribute("position",new THREE.Float32BufferAttribute(t.positions,3)),t.geometry.computeBoundingSphere(),t.geometry.attributes.position.needsUpdate=!0,t.nnNow=0},TEACHER.Line=function(t,e){let o=this;o.nnMax=e||1e4,o.nnNow=0;let i=new THREE.MeshBasicMaterial({color:t||16711935});o.geometry=new THREE.BufferGeometry,o.positions=[],o.geometry.setAttribute("position",new THREE.Float32BufferAttribute(o.positions,3)),o.geometry.computeBoundingSphere(),o.geometry.dynamic=!0,THREE.Line.call(this,o.geometry,i)},TEACHER.Line.prototype=Object.create(THREE.Line.prototype),TEACHER.Line.prototype.constructor=TEACHER.Line,TEACHER.Line.prototype.addPoint=function(t,e,o){let i=this;i.nnNow<i.nnMax?i.nnNow++:(log("TEACHER.Line 到達最大點數"),i.positions.shift(),i.positions.shift(),i.positions.shift()),i.positions.push(t,e,o),i.geometry.setAttribute("position",new THREE.Float32BufferAttribute(i.positions,3)),i.geometry.computeBoundingSphere(),i.geometry.attributes.position.needsUpdate=!0},TEACHER.Line.prototype.clear=function(){let t=this;t.positions=[],t.geometry.setAttribute("position",new THREE.Float32BufferAttribute(t.positions,3)),t.geometry.computeBoundingSphere(),t.geometry.attributes.position.needsUpdate=!0,t.nnNow=0},TEACHER.ObjTextPlane=function(t,e,o,i,n,a){let r=this,l=Math.round(Math.log2(t/e));log(l);let s=$("<canvas>").attr("width",String(128*Math.pow(2,l))).attr("height","128");r.stage=new createjs.Stage(s[0]);let E=new createjs.Container;if(a){let t=new createjs.Shape,e=new THREE.Color(a);t.graphics.c().f("#"+e.getHexString()).dr(0,0,128*Math.pow(2,l),128),E.addChild(t)}r.ctext=new createjs.Text;let p=new THREE.Color(n||16777215);r.ctext.color="#"+p.getHexString(),r.ctext.font="96px Arial",r.ctext.text=o||"",r.ctext.textAlign="center",r.ctext.textBaseline="middle",r.ctext.x=128*Math.pow(2,l)/2,r.ctext.y=64,E.addChild(r.ctext),r.stage.addChild(E),r.stage.update(),r.texture=new THREE.Texture(s[0]);var c=new THREE.MeshBasicMaterial({map:r.texture,transparent:!0}),b=new THREE.PlaneGeometry(t||10,e||10,1,1);r.texture.needsUpdate=!0,r.plane1=new THREE.Mesh(b,c),r.plane2=new THREE.Mesh(b,c),r.plane2.rotation.y=Math.PI;let y=new THREE.Object3D;y.add(r.plane1).add(r.plane2),"x"===i?y.rotation.y=.5*Math.PI:"y"===i&&(y.rotation.x=-.5*Math.PI),THREE.Object3D.call(this),r.add(y)},TEACHER.ObjTextPlane.prototype=Object.create(THREE.Object3D.prototype),TEACHER.ObjTextPlane.prototype.constructor=TEACHER.ObjTextPlane,TEACHER.ObjTextPlane.prototype.setText=function(t){let e=this;e.ctext.text=t,e.stage.update(),e.texture.needsUpdate=!0};var skyBox=new THREE.Object3D;skyBox.wallU=new TEACHER.ObjPicPlane(1e4,1e4,pics.wallU,"y",1),skyBox.wallD=new TEACHER.ObjPicPlane(1e4,1e4,pics.wallD,"y",0),skyBox.wallS=new TEACHER.ObjPicCylinder(5e3,1e4,pics.wallSide,!0,"y",1),skyBox.wallU.position.y=5e3,skyBox.wallD.position.y=-5e3,skyBox.add(skyBox.wallU).add(skyBox.wallD).add(skyBox.wallS),world3D.scene.add(skyBox);var ground=new TEACHER.ObjPicPlane(100,100,pics.ground,"y");world3D.scene.add(ground);var logo=new TEACHER.ObjPicPlane(100,12.5,pics.logo,"z",2);function getMouse3D(t,e){let o,i=t||"y",n=new THREE.Vector3;"x"===i?o=new THREE.Vector3(1,0,0):"y"===i?o=new THREE.Vector3(0,1,0):"z"===i?o=new THREE.Vector3(0,0,1):log("錯誤!!");let a=new THREE.Vector2;return a.x=world2D.stage.mouseX/1600*2-1,a.y=-world2D.stage.mouseY/900*2+1,world3D.raycaster.setFromCamera(a,world3D.camera),world3D.raycaster.ray.intersectPlane(new THREE.Plane(o),n),n}logo.position.z=-50,logo.position.y=6.25,world3D.scene.add(logo),init();