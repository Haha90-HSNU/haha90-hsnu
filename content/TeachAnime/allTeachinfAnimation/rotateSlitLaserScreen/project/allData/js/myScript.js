var fps=60,comp=AdobeAn.getComposition("98EA1A955B63F6489D0F00F6BFD1C4DE"),lib=comp.getLibrary(),myAnimate=new lib.myAnimate,canvas=$("<canvas>").attr("width","1600px").attr("height","900px"),canvasBG=$("<canvas>").attr("width","1600px").attr("height","900px"),canvasGLSL=$("<canvas>").attr("width","1600px").attr("height","900px");$("#mainAnimation").append(canvasGLSL).append(canvasBG).append(canvas);var stage=new createjs.Stage(canvas[0]);stage.enableMouseOver(1e3/60),stage.addChild(myAnimate),createjs.Touch.enable(stage),stage.update();var oldDate,gl,buffer,mac,mLAS,mxOld,myOld,mProtractor,scC,scP,ctx,imageData,showFPS=1,isGLSL=!0,isCanvasDirty=!0,camViewW=1600,camViewH=900,cameraX0=0,cameraY0=0,cameraScale=1,cameraX0Target=0,cameraY0Target=0,cameraScaleTarget=1,slitX0=350,slitY0=450,slitBB=2,slitDD=30,lambda=5,slitDir=0,slitDirTarget=0,laserDir=0,laserDirTarget=0,deltaTheta=999999999,px2cm=1/20,intensityNN=3600,intensityArray=[],dragWho="xx";init();function init(){mac=myAnimate.allControls,mac.slCameraZoom.minimum=.5,mac.slCameraZoom.maximum=2,mac.slCameraZoom.value=1,mac.mBtn.on("click",clickMBtn),mac.panelScreen.x=1320,mac.panelScreen.rbNone.checked=!0,mac.panelScreen.rbNone.on("click",clickRBScreen),mac.panelScreen.rbPlane.on("click",clickRBScreen),mac.panelScreen.rbCircle.on("click",clickRBScreen),mac.panelProtractor.x=1320,mac.panelSlit.x=1320,mac.panelSlit.slBB.minimum=.5,mac.panelSlit.slBB.maximum=5,mac.panelSlit.slBB.value=2,mac.panelSlit.slBB.digitN=1,mac.panelSlit.slDD.minimum=10,mac.panelSlit.slDD.maximum=30,mac.panelSlit.slDD.value=20;for(let a=0;a<=intensityNN;a++)intensityArray.push(0);ctx=canvasBG[0].getContext("2d"),imageData=ctx.getImageData(0,0,canvasBG[0].width,canvasBG[0].height),initGLSL(),mLAS=myAnimate.laserAndSlit,myAnimate.allControls.panelLAS.btnLaser.on("mousedown",downLaser),myAnimate.allControls.panelLAS.btnSlit.on("mousedown",downSlit),myAnimate.allControls.bgBtn.on("mousedown",downBG),myAnimate.on("pressup",myUp),initProtractor(),initScreen(),oldDate=new Date,setInterval(tick,1e3/fps)}function tick(){if(cameraScale=mac.slCameraZoom.value,slitBB=myAnimate.allControls.panelSlit.slBB.value,slitDD=myAnimate.allControls.panelSlit.slDD.value,"bg"===dragWho){let a=stage.mouseX,b=stage.mouseY;cameraX0-=(a-mxOld)/cameraScale,cameraY0-=(b-myOld)/cameraScale,mxOld=a,myOld=b}else if("laser"===dragWho){let a=stage.mouseX,b=stage.mouseY,c=Math.atan2(mac.panelLAS.y-b,mac.panelLAS.x-a),d=Math.atan2(mac.panelLAS.y-myOld,mac.panelLAS.x-mxOld);laserDirTarget+=c-d,laserDirTarget>60*Math.PI/180?laserDirTarget=60*Math.PI/180:laserDirTarget<-60*Math.PI/180?laserDirTarget=-60*Math.PI/180:laserDirTarget>slitDirTarget+70*Math.PI/180?laserDirTarget=slitDirTarget+70*Math.PI/180:laserDirTarget<slitDirTarget-70*Math.PI/180?laserDirTarget=slitDirTarget-70*Math.PI/180:Math.abs(laserDirTarget)<5*Math.PI/180&&(laserDirTarget=0,a=mxOld,b=myOld),mxOld=a,myOld=b}else if("slit"===dragWho){let a=stage.mouseX,b=stage.mouseY,c=Math.atan2(mac.panelLAS.x-a,b-mac.panelLAS.y),d=Math.atan2(mac.panelLAS.x-mxOld,myOld-mac.panelLAS.y);slitDirTarget+=c-d,slitDirTarget>60*Math.PI/180?slitDirTarget=60*Math.PI/180:slitDirTarget<-60*Math.PI/180?slitDirTarget=-60*Math.PI/180:slitDirTarget<laserDirTarget-70*Math.PI/180?slitDirTarget=laserDirTarget-70*Math.PI/180:slitDirTarget>laserDirTarget+70*Math.PI/180?slitDirTarget=laserDirTarget+70*Math.PI/180:Math.abs(slitDirTarget)<5*Math.PI/180&&(slitDirTarget=0,a=mxOld,b=myOld),mxOld=a,myOld=b}laserDir=.95*laserDir+.05*laserDirTarget,slitDir=.95*slitDir+.05*slitDirTarget,myAnimate.allControls.panelLAS.ttSlit.text=Math.round(Math.abs(180*slitDir/Math.PI)),myAnimate.allControls.panelLAS.ttLaser.text=Math.round(Math.abs(180*laserDir/Math.PI)),mLAS.x=-cameraX0*cameraScale+camViewW/2,mLAS.y=-cameraY0*cameraScale+camViewH/2,mLAS.scaleX=mLAS.scaleY=cameraScale,mLAS.laserBG.x=-125*Math.cos(laserDir),mLAS.laserBG.y=-125*Math.sin(laserDir),mac.panelLAS.btnLaser.rotation=mLAS.laserBG.rotation=180*laserDir/Math.PI,mac.panelLAS.btnSlit.rotation=mLAS.theSlit.rotation=mLAS.bigMask.rotation=180*slitDir/Math.PI,mLAS.theSlit.media1.scaleY=mLAS.theSlit.media2.scaleY=slitBB*lambda/100,mLAS.theSlit.media1.y=-.5*slitDD*lambda,mLAS.theSlit.media2.y=.5*slitDD*lambda,updateProtractor();let a=laserDir-slitDir;a!=deltaTheta&&(deltaTheta=a,isCanvasDirty=!0),isCanvasDirty&&(isGLSL?drawBG_GLSL():drawBG_JS()),updateScreen();let b=new Date;showFPS=.95*showFPS+50/(b.getTime()-oldDate.getTime()),myAnimate.ttxx.text="fps="+Math.round(100*showFPS)/100,oldDate=b,stage.update()}function downBG(){dragWho="bg",mxOld=stage.mouseX,myOld=stage.mouseY}function downLaser(){dragWho="laser",mxOld=stage.mouseX,myOld=stage.mouseY}function downSlit(){dragWho="slit",mxOld=stage.mouseX,myOld=stage.mouseY}function myUp(){dragWho="x"}function clickMBtn(){let a=mac.panelProtractor.x<1470?1620:1320;createjs.Tween.get(mac.panelProtractor).to({x:a},800),createjs.Tween.get(mac.panelScreen).to({x:a},800),createjs.Tween.get(mac.panelSlit).to({x:a},800)}function clickRBScreen(a){let b=a.target.parent.name;log(b),mac.panelScreen.rbNone.checked="rbNone"===b,mac.panelScreen.rbPlane.checked="rbPlane"===b,mac.panelScreen.rbCircle.checked="rbCircle"===b}function drawBG_JS(){for(let a=0;a<=intensityNN;a++){let b=a/intensityNN*Math.PI-.5*Math.PI,c=Math.PI*slitBB*(Math.sin(b)-Math.sin(deltaTheta)),d=Math.PI*slitDD*(Math.sin(b)-Math.sin(deltaTheta)),e=Math.cos(d)*Math.sin(c)/c||1;intensityArray[a]=Math.sqrt(e*e)}let a=imageData.data,b=a.length;for(let c=0;c<b;c+=4){let b=c/4%canvasBG[0].width,d=c/4/canvasBG[0].width,e=Math.atan2(d+cameraY0*cameraScale-camViewH/2,b+cameraX0*cameraScale-camViewW/2);e-=slitDir;let f=0;e>.5*Math.PI||e<-.5*Math.PI||(f=getIntensity(e)),a[c]=0,a[c+1]=255*f,a[c+2]=0,a[c+3]=255}ctx.putImageData(imageData,0,0)}function drawBG_GLSL(){let a=gl.getUniformLocation(program,"x0"),b=gl.getUniformLocation(program,"y0"),c=gl.getUniformLocation(program,"slitDir"),d=gl.getUniformLocation(program,"slitBB"),e=gl.getUniformLocation(program,"slitDD"),f=gl.getUniformLocation(program,"isInt"),g=gl.getUniformLocation(program,"deltaTheta");gl.uniform1f(a,cameraX0*cameraScale-camViewW/2),gl.uniform1f(b,cameraY0*cameraScale-camViewH/2),gl.uniform1f(c,slitDir),gl.uniform1f(d,slitBB),gl.uniform1f(e,slitDD),gl.uniform1f(f,myAnimate.allControls.panelSlit.chInterference.checked?1:0),gl.uniform1f(g,deltaTheta),positionLocation=gl.getAttribLocation(program,"a_position"),gl.enableVertexAttribArray(positionLocation),gl.vertexAttribPointer(positionLocation,2,gl.FLOAT,!1,0,0),gl.drawArrays(gl.TRIANGLES,0,6)}function getIntensity(a){let b=a+.5*Math.PI,c=Math.floor(b/Math.PI*intensityNN),d=b/Math.PI*intensityNN-c;return intensityArray[c]*(1-d)+intensityArray[c+1]*d}function initProtractor(){mProtractor=myAnimate.theProtractor,mProtractor.pt1.visible=mProtractor.pt2.visible=mProtractor.pt3.visible=!1,mProtractor.ruler.rt.visible=!1,mProtractor.tickNN=100,mProtractor.tickArray1=[],mProtractor.tickArray2=[],mProtractor.tickArray3=[],mProtractor.rTickArray=[];for(let a,b=0;b<mProtractor.tickNN;b++){a=new lib.pTick1,mProtractor.tickArray1.push(a),mProtractor.emp.addChild(a);let b=new lib.pTick2;mProtractor.tickArray2.push(b),mProtractor.emp.addChild(b);let c=new lib.pTick3;mProtractor.tickArray3.push(c),mProtractor.emp.addChild(c);let d=new lib.rTick;mProtractor.rTickArray.push(d),mProtractor.ruler.addChild(d)}}function updateProtractor(){let a=mac.panelProtractor.chDelta1.checked,b=mac.panelProtractor.chDelta2.checked,c=mac.panelProtractor.chProtractor.checked,d=mac.panelProtractor.chRuler.checked,e=-1*Math.floor(slitDD),f=-1*Math.floor(slitDD*(1+Math.sin(deltaTheta)));for(let d=0;d<mProtractor.tickNN;d++){let g=mProtractor.tickArray1[d],h=Math.asin(e/slitDD);h<=.5*Math.PI&&h>=-.5*Math.PI?(g.visible=a,g.tt1.text=g.tt2.text=Math.abs(e),g.x=355*Math.cos(h),g.y=355*Math.sin(h),g.rotation=180*h/Math.PI):g.visible=!1,e++;let i=mProtractor.tickArray2[d],j=Math.asin(f/slitDD+Math.sin(deltaTheta));j<=.5*Math.PI&&j>=-.5*Math.PI?(i.visible=b,i.tt1.text=i.tt2.text=Math.abs(f),i.x=345*Math.cos(j),i.y=345*Math.sin(j),i.rotation=180*j/Math.PI):i.visible=!1,f++;let k=mProtractor.tickArray3[d],l=-90+10*d;90>=l?(k.visible=c,k.tt1.text=k.tt2.text=Math.abs(l),k.x=220*Math.cos(l*Math.PI/180),k.y=220*Math.sin(l*Math.PI/180),k.rotation=l,k.gotoAndStop(0==Math.abs(l)%30?1:0)):k.visible=!1;let m=mProtractor.rTickArray[d],n=400+200*d;m.x=n-390,m.y=34,m.tt1.text=m.tt2.text=n*px2cm+"cm"}mProtractor.x=mLAS.x,mProtractor.y=mLAS.y,mProtractor.scaleX=mProtractor.scaleY=cameraScale,mProtractor.rotation=180*slitDir/Math.PI,mProtractor.gotoAndStop(a||b?0:1);let g=-mac.panelProtractor.slRulerRotation.value*Math.PI/180;mProtractor.ruler.x=390*Math.cos(slitDir+g),mProtractor.ruler.y=-390*Math.sin(slitDir+g),mProtractor.ruler.rotation=180*-(slitDir+g)/Math.PI,mac.panelProtractor.slRulerRotation.visible=mProtractor.ruler.visible=d,mProtractor.labelDelta1.visible=a,mProtractor.labelDelta2.visible=b}function initScreen(){scC=myAnimate.screenCircle,scP=myAnimate.screenPlane,scC.st.visible=!1,scC.stText.visible=!1,scC.tickNN=100,scC.tickArray=[],scC.tickTextArray=[];for(let a,b=0;b<scC.tickNN;b++){a=new lib.sTick,scC.emp.addChild(a),scC.tickArray.push(a);let b=new lib.sText1;scC.emp.addChild(b),scC.tickTextArray.push(b)}scP.st.visible=!1,scP.stText.visible=!1,scP.tickNN=100,scP.tickArray=[],scP.tickTextArray=[];for(let a,b=0;b<scP.tickNN;b++){a=new lib.sTick,scP.emp.addChild(a),scP.tickArray.push(a);let b=new lib.sText2;scP.emp.addChild(b),scP.tickTextArray.push(b)}mac.panelScreen.slScreenRotation.minimum=-60,mac.panelScreen.slScreenRotation.maximum=60,mac.panelScreen.slScreenRotation.value=0,mac.panelScreen.slScreenDistance.minimum=500,mac.panelScreen.slScreenDistance.maximum=2500,mac.panelScreen.slScreenDistance.value=1e3,mac.panelProtractor.slRulerRotation.minimum=-60,mac.panelProtractor.slRulerRotation.maximum=60,mac.panelProtractor.slRulerRotation.value=0}function updateScreen(){if(scC.visible=mac.panelScreen.rbCircle.checked,scP.visible=mac.panelScreen.rbPlane.checked,mac.panelScreen.slScreenDistance.visible=mac.panelScreen.rbPlane.checked,mac.panelScreen.slScreenRotation.visible=mac.panelScreen.rbPlane.checked,mac.panelScreen.chText.visible=mac.panelScreen.rbPlane.checked||mac.panelScreen.rbCircle.checked,mac.panelScreen.rbCircle.checked){let a=-1*Math.floor(slitDD*(1+Math.sin(deltaTheta)));for(let b=0;b<scC.tickNN;b++){let c=scC.tickArray[b],d=Math.asin((a-.5)/slitDD+Math.sin(deltaTheta));if(d<=.5*Math.PI&&d>=-.5*Math.PI?(c.visible=mac.panelScreen.chText.checked,c.x=1e3*Math.cos(d),c.y=1e3*Math.sin(d),c.rotation=180*d/Math.PI,c.theta=d,c.ttxx.text=0>a?-1*a:a+1,c.ttxx.visible=!1):c.visible=!1,a++,0<b){let a=scC.tickTextArray[b-1],c=.5*(scC.tickArray[b-1].theta+scC.tickArray[b].theta);a.x=1e3*Math.cos(c),a.y=1e3*Math.sin(c),a.rotation=180*c/Math.PI,a.ttt.text=digitN(180*Math.abs(scC.tickArray[b-1].theta-scC.tickArray[b].theta)/Math.PI,1),a.visible=scC.tickArray[b-1].visible&&scC.tickArray[b].visible&&mac.panelScreen.chText.checked}}scC.tickTextArray[scC.tickNN-1].visible=!1,scC.x=mLAS.x,scC.y=mLAS.y,scC.scaleX=scC.scaleY=cameraScale,scC.rotation=mProtractor.rotation}if(mac.panelScreen.rbPlane.checked){let a=-1*Math.floor(slitDD*(1+Math.sin(deltaTheta)));5>Math.abs(mac.panelScreen.slScreenRotation.value)&&(mac.panelScreen.slScreenRotation.value=0);let b=mac.panelScreen.slScreenRotation.value*Math.PI/180,c=mac.panelScreen.slScreenDistance.value;for(let d=0;d<scP.tickNN;d++){let e=scP.tickArray[d],f=Math.asin((a-.5)/slitDD+Math.sin(deltaTheta)),g=c*Math.tan(f+slitDir)/(Math.cos(b)+Math.sin(b)*Math.tan(f+slitDir));if(0<=(f+slitDir)*g?(e.visible=mac.panelScreen.chText.checked,e.x=0,e.y=g,e.tickY=g,e.ttxx.text=a,e.ttxx.visible=!1):e.visible=!1,a++,0<d){let a=scP.tickTextArray[d-1];a.y=.5*(scP.tickArray[d-1].tickY+scP.tickArray[d].tickY),a.ttt.text=digitN(Math.abs(scP.tickArray[d-1].tickY-scP.tickArray[d].tickY)*px2cm,1)+"cm",a.visible=scP.tickArray[d-1].visible&&scP.tickArray[d].visible&&mac.panelScreen.chText.checked}}scP.tickTextArray[scP.tickNN-1].visible=!1,scP.x=mLAS.x+c*cameraScale,scP.y=mLAS.y,scP.scaleX=scP.scaleY=cameraScale,scP.rotation=180*b/Math.PI}}function digitN(a,b){let c=0>a?"-":"",d=Math.abs(a),e=Math.round(d*Math.pow(10,b))+"";if(0<b){if(e.length<b+1)for(var f=b+1-e.length,g=0;g<f;g++)e="0"+e;e=c+e.substr(0,e.length-b)+"."+e.substr(e.length-b)}else e=c+(Math.round(d)+"");return e}MyJS.myResize();function initGLSL(){gl=canvasGLSL[0].getContext("experimental-webgl"),gl.viewport(0,0,gl.drawingBufferWidth,gl.drawingBufferHeight),buffer=gl.createBuffer(),gl.bindBuffer(gl.ARRAY_BUFFER,buffer),gl.bufferData(gl.ARRAY_BUFFER,new Float32Array([-1,-1,1,-1,-1,1,-1,1,1,-1,1,1]),gl.STATIC_DRAW);var a,b,c,d;a=document.getElementById("2d-vertex-shader"),b=a.text,c=gl.createShader(gl.VERTEX_SHADER),gl.shaderSource(c,b),gl.compileShader(c),a=document.getElementById("2d-fragment-shader"),b=a.text,d=gl.createShader(gl.FRAGMENT_SHADER),gl.shaderSource(d,b),gl.compileShader(d),program=gl.createProgram(),gl.attachShader(program,c),gl.attachShader(program,d),gl.linkProgram(program),gl.useProgram(program)}