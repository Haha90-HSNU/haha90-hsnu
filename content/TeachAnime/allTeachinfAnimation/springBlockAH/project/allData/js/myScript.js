"use strict";var ballA,ballB,spring,arrowF,fps=60,log=console.log,gameMD=0,mA=10,mB=10,kk=20,dt=.01,L0=20,wxL=-40,wxR=1040,isPlay=!1,isStep=!1,cameraFollowRatio=1;function init(){ballA=new TEACHER.ObjBox(10,10,10,65535),ballB=new TEACHER.ObjBox(10,10,10,52224),spring=new TEACHER.ObjSpring(L0,3,.3,8,16776960),scene.add(ballA).add(ballB).add(spring);var t=new TEACHER.ObjBox(5,20,20,10053120),e=new TEACHER.ObjBox(5,20,20,10053120);t.position.x=wxL-2.5,e.position.x=wxR+2.5,t.position.y=e.position.y=10,scene.add(t).add(e),(arrowF=new TEACHER.ObjArrow(2,16750848)).setArrow(-10,0,0),arrowF.position.x=15,ballB.add(arrowF);for(var o=0;o<10;o++){var i=new TEACHER.ObjPicPlane(100,100,pics.ground,"y");i.position.x=100*(o+1),scene.add(i)}world2D.btn01.setLabel("壓/放"),world2D.btn01.on("mousedown",btn01Down),world2D.btn01.on("pressup",btn01Up),world2D.btn02.setLabel("重來"),world2D.btn02.on("click",clickBtn02),world2D.ch01.setLabel("跟隨"),world2D.ch01.checked=!0,world2D.ch02.setLabel("慢動作"),world2D.sl01.visible=world2D.sl02.visible=world2D.sl03.visible=!1,world2D.btnUp.visible=world2D.btnDown.visible=world2D.btnLeft.visible=world2D.btnRight.visible=!1,initGame(),setInterval(tick,1e3/fps)}function tick(){if(0===gameMD);else if(1===gameMD)ballB.position.x>-25+L0-10&&(ballB.position.x-=.2);else if(2===gameMD){let o=world2D.ch02.checked?1:10;for(var t=0;t<o;t++){var e=-kk*(ballB.position.x-ballA.position.x-10-L0);ballA.vx-=e/mA*dt,ballB.vx+=e/mB*dt,ballA.position.x+=ballA.vx*dt,ballB.position.x+=ballB.vx*dt,ballA.position.x<wxL+5&&(ballA.position.x=wxL+5,ballA.vx=0),ballB.position.x>wxR-5&&(ballB.position.x=wxR-5,ballB.vx=0)}}spring.position.x=ballA.position.x+5,spring.setSpring(ballB.position.x-ballA.position.x-10,0,0),arrowF.visible=1===gameMD,world2D.ch01.checked&&cameraFollowRatio<1?(cameraFollowRatio+=.01)>1&&(cameraFollowRatio=1):!world2D.ch01.checked&&cameraFollowRatio>0&&(cameraFollowRatio-=.01)<0&&(cameraFollowRatio=0),world3D.cameraTarget.x=.5*(ballA.position.x+ballB.position.x)*cameraFollowRatio,world3D.render(),world2D.stage.update()}function initGame(){ballA.position.y=5,ballA.position.x=-35,ballB.position.y=5,ballB.position.x=-25+L0,spring.position.x=ballA.position.x+5,spring.position.y=5,spring.setSpring(ballB.position.x-ballA.position.x-10,0,0),world2D.btn01.visible=!0,world2D.btn02.visible=!1}function btn01Down(t){0===gameMD&&(gameMD=1)}function btn01Up(t){1===gameMD&&(gameMD=2,ballA.vx=ballB.vx=0,world2D.btn01.visible=!1,world2D.btn02.visible=!0)}function clickBtn02(t){gameMD=0,initGame()}MyJS.myResize();var TEACHER={ObjPlane:function(t,e,o,i,n){let r=this;r.mat=new TEACHER.MSMat(o,n),r.geo=new THREE.PlaneGeometry(t||10,e||10,1,1),r.mesh=new THREE.Mesh(r.geo,r.mat),"x"===i?r.mesh.rotation.y=.5*Math.PI:"y"===i&&(r.mesh.rotation.x=-.5*Math.PI),THREE.Object3D.call(this,r.geo,r.mat),r.add(r.mesh)}};TEACHER.ObjPlane.prototype=Object.create(THREE.Object3D.prototype),TEACHER.ObjPlane.prototype.constructor=TEACHER.ObjPlane,TEACHER.ObjCylinder=function(t,e,o,i,n,r){let a=this;a.mat=new TEACHER.MSMat(o,r),a.geo=new THREE.CylinderGeometry(t||10,t||10,e||10,32,2,i),a.mesh=new THREE.Mesh(a.geo,a.mat),"x"===n?a.mesh.rotation.z=-.5*Math.PI:"z"===n&&(a.mesh.rotation.x=.5*Math.PI),THREE.Object3D.call(this,a.geo,a.mat),a.add(a.mesh)},TEACHER.ObjCylinder.prototype=Object.create(THREE.Object3D.prototype),TEACHER.ObjCylinder.prototype.constructor=TEACHER.ObjCylinder,TEACHER.ObjSphere=function(t,e,o){let i=this;i.mat=new TEACHER.MSMat(e,o),i.geo=new THREE.SphereGeometry(t||10,32,16),i.mesh=new THREE.Mesh(i.geo,i.mat),THREE.Object3D.call(this,i.geo,i.mat),i.add(i.mesh)},TEACHER.ObjSphere.prototype=Object.create(THREE.Object3D.prototype),TEACHER.ObjSphere.prototype.constructor=TEACHER.ObjSphere,TEACHER.ObjBox=function(t,e,o,i,n){let r=this;r.mat=new TEACHER.MSMat(i,n),r.geo=new THREE.BoxGeometry(t||10,e||10,o||10),r.mesh=new THREE.Mesh(r.geo,r.mat),THREE.Object3D.call(this,r.geo,r.mat),r.add(r.mesh)},TEACHER.ObjBox.prototype=Object.create(THREE.Object3D.prototype),TEACHER.ObjBox.prototype.constructor=TEACHER.ObjBox,TEACHER.MSMat=function(t,e){THREE.MeshStandardMaterial.call(this,{color:t||16711935,roughness:.4,side:e||0})},TEACHER.MSMat.prototype=Object.create(THREE.MeshStandardMaterial.prototype),TEACHER.MSMat.prototype.constructor=TEACHER.MSMat,TEACHER.ObjPicPlane=function(t,e,o,i,n){let r=this,a=(new THREE.TextureLoader).load(o);r.mat=new THREE.MeshBasicMaterial({map:a,transparent:!0,side:n||0}),r.geo=new THREE.PlaneGeometry(t,e,1,1),r.mesh=new THREE.Mesh(r.geo,r.mat),"x"===i?r.mesh.rotation.y=.5*Math.PI:"y"===i&&(r.mesh.rotation.x=-.5*Math.PI),THREE.Object3D.call(this),r.add(r.mesh)},TEACHER.ObjPicPlane.prototype=Object.create(THREE.Object3D.prototype),TEACHER.ObjPicPlane.prototype.constructor=TEACHER.ObjPicPlane,TEACHER.ObjPicCylinder=function(t,e,o,i,n,r){let a=this,s=(new THREE.TextureLoader).load(o);a.mat=new THREE.MeshBasicMaterial({map:s,side:r||0}),a.geo=new THREE.CylinderGeometry(t||10,t||10,e||10,32,4,i),a.mesh=new THREE.Mesh(a.geo,a.mat),"x"===n?a.mesh.rotation.z=-.5*Math.PI:"z"===n?(a.mesh.rotation.y=.5*Math.PI,a.mesh.rotation.x=.5*Math.PI):"y"===n&&(a.mesh.rotation.y=.5*Math.PI),THREE.Object3D.call(this,a.geo,a.mat),a.add(a.mesh)},TEACHER.ObjPicCylinder.prototype=Object.create(THREE.Object3D.prototype),TEACHER.ObjPicCylinder.prototype.constructor=TEACHER.ObjPicCylinder,TEACHER.ObjPicSphere=function(t,e,o){let i=this,n=(new THREE.TextureLoader).load(e);i.mat=new THREE.MeshBasicMaterial({map:n,side:o||0}),i.geo=new THREE.SphereGeometry(t||10,32,16),i.mesh=new THREE.Mesh(i.geo,i.mat),THREE.Object3D.call(this,i.geo,i.mat),i.add(i.mesh)},TEACHER.ObjPicSphere.prototype=Object.create(THREE.Object3D.prototype),TEACHER.ObjPicSphere.prototype.constructor=TEACHER.ObjPicSphere,TEACHER.ObjArrow=function(t,e){let o=new THREE.MeshStandardMaterial({color:e||16711935,roughness:.4}),i=new THREE.ConeGeometry(t||10,40,32);this.ArrowHead=new THREE.Mesh(i,o),this.ArrowHead.position.y=80,i=new THREE.CylinderGeometry(.5*(t||10),.5*(t||10),60,32,2),this.ArrowBody=new THREE.Mesh(i,o),this.ArrowBody.position.y=30,THREE.Object3D.call(this),this.rotX=new THREE.Object3D,this.rotY=new THREE.Object3D,this.add(this.rotY),this.rotY.add(this.rotX),this.rotX.add(this.ArrowBody),this.rotX.add(this.ArrowHead)},TEACHER.ObjArrow.prototype=Object.create(THREE.Object3D.prototype),TEACHER.ObjArrow.prototype.constructor=TEACHER.ObjArrow,TEACHER.ObjArrow.prototype.setArrow=function(t,e,o){let i=t*t+e*e+o*o,n=Math.sqrt(i);i>0?(this.rotX.visible=!0,this.rotX.scale.y=n/100):this.rotX.visible=!1,this.rotX.rotation.x=Math.acos(e/n),this.rotY.rotation.y=Math.atan2(t,o)},TEACHER.ObjSpring=function(t,e,o,i,n){let r=t||20;this.L0=r;let a=[],s=i||5,E=e||5,l=o||.5;a.push(new THREE.Vector3(0,0,0)),a.push(new THREE.Vector3(0,.05*r,0));for(var p=0;p<=16*s;p++)a.push(new THREE.Vector3(E*Math.cos(2*p*Math.PI/16),r*(.05+.9*p/s/16),E*Math.sin(2*p*Math.PI/16)));a.push(new THREE.Vector3(0,.95*r,0)),a.push(new THREE.Vector3(0,r,0));let c=new THREE.CatmullRomCurve3(a),h=new THREE.MeshStandardMaterial({color:n||16711935,roughness:.4}),d=new THREE.TubeGeometry(c,500,l,12);this.mesh=new THREE.Mesh(d,h),THREE.Object3D.call(this),this.rotX=new THREE.Object3D,this.rotY=new THREE.Object3D,this.add(this.rotY),this.rotY.add(this.rotX),this.rotX.add(this.mesh)},TEACHER.ObjSpring.prototype=Object.create(THREE.Object3D.prototype),TEACHER.ObjSpring.prototype.constructor=TEACHER.ObjSpring,TEACHER.ObjSpring.prototype.setSpring=function(t,e,o){let i=t*t+e*e+o*o,n=Math.sqrt(i);i>0?(this.rotX.visible=!0,this.rotX.scale.y=n/this.L0):this.rotX.visible=!1,this.rotX.rotation.x=Math.acos(e/n),this.rotY.rotation.y=Math.atan2(t,o)},TEACHER.Points=function(t,e,o){let i=this,n=e||1,r=t||16711935,a=new THREE.Color(r);i.nnMax=o||1e4,i.nnNow=0,i.geometry=new THREE.BufferGeometry,i.positions=[],i.geometry.setAttribute("position",new THREE.Float32BufferAttribute(i.positions,3)),i.geometry.computeBoundingSphere();let s=new THREE.PointsMaterial({size:n,map:i.createCanvasMaterial("#"+a.getHexString(),64),transparent:!0,depthWrite:!1});THREE.Points.call(this,i.geometry,s)},TEACHER.Points.prototype=Object.create(THREE.Points.prototype),TEACHER.Points.prototype.constructor=TEACHER.Points,TEACHER.Points.prototype.createCanvasMaterial=function(t,e){var o=document.createElement("canvas");o.width=o.height=e;var i=o.getContext("2d");i.imageSmoothingEnabled=!1;var n=new THREE.Texture(o),r=e/2;return i.beginPath(),i.arc(r,r,e/2-3,0,2*Math.PI,!1),i.closePath(),i.fillStyle=t,i.fill(),n.needsUpdate=!0,n},TEACHER.Points.prototype.addPoint=function(t,e,o){let i=this;i.nnNow<i.nnMax?i.nnNow++:(log("TEACHER.Points 到達最大點數"),i.positions.shift(),i.positions.shift(),i.positions.shift()),i.positions.push(t,e,o),i.geometry.setAttribute("position",new THREE.Float32BufferAttribute(i.positions,3)),i.geometry.computeBoundingSphere(),i.geometry.attributes.position.needsUpdate=!0},TEACHER.Points.prototype.clear=function(){let t=this;t.positions=[],t.geometry.setAttribute("position",new THREE.Float32BufferAttribute(t.positions,3)),t.geometry.computeBoundingSphere(),t.geometry.attributes.position.needsUpdate=!0,t.nnNow=0},TEACHER.Line=function(t,e){let o=this;o.nnMax=e||1e4,o.nnNow=0;let i=new THREE.MeshBasicMaterial({color:t||16711935});o.geometry=new THREE.BufferGeometry,o.positions=[],o.geometry.setAttribute("position",new THREE.Float32BufferAttribute(o.positions,3)),o.geometry.computeBoundingSphere(),o.geometry.dynamic=!0,THREE.Line.call(this,o.geometry,i)},TEACHER.Line.prototype=Object.create(THREE.Line.prototype),TEACHER.Line.prototype.constructor=TEACHER.Line,TEACHER.Line.prototype.addPoint=function(t,e,o){let i=this;i.nnNow<i.nnMax?i.nnNow++:(log("TEACHER.Line 到達最大點數"),i.positions.shift(),i.positions.shift(),i.positions.shift()),i.positions.push(t,e,o),i.geometry.setAttribute("position",new THREE.Float32BufferAttribute(i.positions,3)),i.geometry.computeBoundingSphere(),i.geometry.attributes.position.needsUpdate=!0},TEACHER.Line.prototype.clear=function(){let t=this;t.positions=[],t.geometry.setAttribute("position",new THREE.Float32BufferAttribute(t.positions,3)),t.geometry.computeBoundingSphere(),t.geometry.attributes.position.needsUpdate=!0,t.nnNow=0},TEACHER.ObjTextPlane=function(t,e,o,i,n,r){let a=this,s=Math.round(Math.log2(t/e));log(s);let E=$("<canvas>").attr("width",String(128*Math.pow(2,s))).attr("height","128");a.stage=new createjs.Stage(E[0]);let l=new createjs.Container;if(r){let t=new createjs.Shape,e=new THREE.Color(r);t.graphics.c().f("#"+e.getHexString()).dr(0,0,128*Math.pow(2,s),128),l.addChild(t)}a.ctext=new createjs.Text;let p=new THREE.Color(n||16777215);a.ctext.color="#"+p.getHexString(),a.ctext.font="96px Arial",a.ctext.text=o||"",a.ctext.textAlign="center",a.ctext.textBaseline="middle",a.ctext.x=128*Math.pow(2,s)/2,a.ctext.y=64,l.addChild(a.ctext),a.stage.addChild(l),a.stage.update(),a.texture=new THREE.Texture(E[0]);var c=new THREE.MeshBasicMaterial({map:a.texture,transparent:!0}),h=new THREE.PlaneGeometry(t||10,e||10,1,1);a.texture.needsUpdate=!0,a.plane1=new THREE.Mesh(h,c),a.plane2=new THREE.Mesh(h,c),a.plane2.rotation.y=Math.PI;let d=new THREE.Object3D;d.add(a.plane1).add(a.plane2),"x"===i?d.rotation.y=.5*Math.PI:"y"===i&&(d.rotation.x=-.5*Math.PI),THREE.Object3D.call(this),a.add(d)},TEACHER.ObjTextPlane.prototype=Object.create(THREE.Object3D.prototype),TEACHER.ObjTextPlane.prototype.constructor=TEACHER.ObjTextPlane,TEACHER.ObjTextPlane.prototype.setText=function(t){let e=this;e.ctext.text=t,e.stage.update(),e.texture.needsUpdate=!0};var skyBox=new THREE.Object3D;skyBox.wallU=new TEACHER.ObjPicPlane(1e4,1e4,pics.wallU,"y",1),skyBox.wallD=new TEACHER.ObjPicPlane(1e4,1e4,pics.wallD,"y",0),skyBox.wallS=new TEACHER.ObjPicCylinder(5e3,1e4,pics.wallSide,!0,"y",1),skyBox.wallU.position.y=5e3,skyBox.wallD.position.y=-5e3,skyBox.add(skyBox.wallU).add(skyBox.wallD).add(skyBox.wallS),world3D.scene.add(skyBox);var ground=new TEACHER.ObjPicPlane(100,100,pics.ground,"y");world3D.scene.add(ground);var logo=new TEACHER.ObjPicPlane(100,12.5,pics.logo,"z",2);function getMouse3D(t,e){let o,i=t||"y",n=new THREE.Vector3;"x"===i?o=new THREE.Vector3(1,0,0):"y"===i?o=new THREE.Vector3(0,1,0):"z"===i?o=new THREE.Vector3(0,0,1):log("錯誤!!");let r=new THREE.Vector2;return r.x=world2D.stage.mouseX/1600*2-1,r.y=-world2D.stage.mouseY/900*2+1,world3D.raycaster.setFromCamera(r,world3D.camera),world3D.raycaster.ray.intersectPlane(new THREE.Plane(o),n),n}logo.position.z=-50,logo.position.y=6.25,world3D.scene.add(logo),init();